<h2><center>Edit Data Entry</center></h2>

<!-- Step Labels -->
<div class="form-section-label step-labels-section">
  <div class="step-labels">
    <span class="label current">
      Personal Info +<br>Waste Generation
    </span>

    {{#each supertypes}}
      <span class="label">
        Waste Composition<br>{{name}}
      </span>
    {{/each}}

    <span class="label current">
      User Comments
    </span>
  </div>
</div>

<form id="waste-form" data-prefill-region="{{prefill.region}}" data-prefill-province="{{prefill.province}}" data-prefill-municipality="{{prefill.municipality}}" data-prefill-barangay="{{prefill.barangay}}" novalidate>

    <!-- Pass data entry ID to submission JS -->
    <input type="hidden" name="dataEntryId" value="{{dataEntryId}}">

    <!-- Step 1 -->
    <div class="step active" data-step="0">
        <!-- Title Section -->
        <div class="form-section">
            <h3><i class="fas fa-heading"></i> Submission Title</h3>

            <label for="title">Title<span class="required">*</span></label>
            <input type="text" name="title" id="title"
                    placeholder="Provide a meaningful title (up to 100 characters only)" maxlength="100" value="{{wasteGen.title}}">
            <div class="error-msg" id="error-title"></div>
        </div>

        <!-- Personal Information -->
        <div class="form-section">
            <h3><i class="fas fa-user"></i> Personal Information</h3>
            <p><strong>Name:</strong> {{uppercase user.lastname}}, {{user.firstname}}</p>
            <p><strong>Company:</strong> {{user.company}}</p>
            <input type="hidden" id="company" name="company" value="{{user.company}}">
        </div>

        <!-- Location Selection -->
        <div class="form-section">
            <h3><i class="fas fa-map-marker-alt"></i> Select Location</h3>

            <label for="regions">Region<span class="required">*</span></label>
            <select name="region" id="regions">
            <option value="">Select a region</option>
                <!-- Populated by locations.js -->
            </select>
            <div class="error-msg" id="error-regions"></div>

            <label for="provinces">Province</label>
            <select name="province" id="provinces" disabled>
                <option value="">Select a province</option>
                <!-- Populated by locations.js -->
            </select>

            <label for="municipalities">City/Municipality</label>
            <select name="municipality" id="municipalities" disabled>
                <option value="">Select a city/municipality</option>
                <!-- Populated by locations.js -->
            </select>

            <label for="barangay">Barangay (if applicable)</label>
            <select name="barangay" id="barangay" disabled>
                <option value="">Select a barangay</option>
                <!-- Populated by locations.js -->
            </select>
        </div>

        <!-- Location & Waste Information -->
        <div class="form-section">
            <h3><i class="fas fa-database"></i> Waste Generation & Collection Info</h3>

            <label for="population">Population (based on Census)<span class="required">*</span></label>
            <input type="number" id="population" name="population" min="0" value="{{wasteGen.population}}">
            <div class="error-msg" id="error-population"></div>

            <label for="per_capita">Waste Generation per Capita (Kg/cap-day)<span class="required">*</span></label>
            <input type="number" id="per_capita" name="per_capita" min="0" step="0.001" value="{{wasteGen.per_capita}}">
            <div class="error-msg" id="error-per_capita"></div>

            <label for="annual">Annual Waste Generation (kg/year)<span class="required">*</span></label>
            <input type="number" id="annual" name="annual" min="0" step="0.001" value="{{wasteGen.annual}}">
            <div class="error-msg" id="error-annual"></div>

            <label for="date_start">Data Collection Start Date<span class="required">*</span></label>
            <input type="date" id="date_start" name="date_start" value="{{wasteGen.collection_start}}">
            <div class="error-msg" id="error-date_start"></div>

            <label for="date_end">Data Collection End Date<span class="required">*</span></label>
            <input type="date" id="date_end" name="date_end" value="{{wasteGen.collection_end}}">
            <div class="error-msg" id="error-date_end"></div>
        </div>
    </div>

    <!-- Waste Composition -->
    {{#each supertypes}}
        <div class="form-section form-table waste-supertype step" data-step="{{id}}">
            <h3><i class="fas fa-recycle"></i> Waste Composition: {{uppercase name}}</h3>
            <h3 style="font-weight: normal;">NOTE: Values must be the weight in&nbsp; <b>kilograms (kg)</b>.</h3>

            <div class="waste-table-wrapper">
              <table class="waste-table">
                  <thead>
                  <tr>
                      <th>Type of Waste</th>
                      {{#each ../sectors}}
                      <th>{{name}}</th>
                      {{/each}}
                  </tr>
                  </thead>
                  <tbody>
                    {{#each types}}
                        <tr>
                        <td>{{name}}</td>
                        {{#each ../../sectors}}
                            <td>
                            <input
                                type="number"
                                sectorId="{{id}}"
                                typeId="{{../id}}"
                                class="waste-entry"
                                min="0"
                                step="0.01"
                                value="{{lookup @root.wasteMap (concat id ../id)}}"
                            >
                            </td>
                        {{/each}}
                        </tr>
                    {{/each}}
                    </tbody>
              </table>
            </div>
        </div>
    {{/each}}

    <!-- User comments (mandatory) -->
    <div class="form-section form-table waste-supertype step" data-step="5">
      <h3><i class="fas fa-recycle"></i> User Comments</h3>
      <h3 style="font-weight: normal;">Describe the changes made to your entry.&nbsp;<span style="color: red;">(required)</span> </h3>

      <textarea id="comment" name="comment" rows="10"></textarea>
    </div>

    <div>
        <center>
            <button type="button" id="prevBtn" class="disabled upload-btn">Previous</button>
            <button type="button" id="nextBtn" class="disabled upload-btn">Next</button>
            <button type="button" id="modalBtn" class="disabled upload-btn" onclick="showConfirm()">Submit Changes</button>
        </center>
    </div>

<!-- Confirm modal -->
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <span id="confirm-close" class="close">&times;</span>
        <h3>Confirm Changes</h3>
        <h3 style="font-weight: normal;">Submit changes?</h3>

        <button type="button" id="confirm-no" class="review-cancel">
          No
        </button>&emsp;

        <button type="submit" id="confirm-yes" class="review-approve">
          Yes
        </button>
    </div>
</div>
</form>

<!-- Success modal -->
<div id="success-approve" class="modal">
    <div class="modal-content">
        <h3>Success</h3>
        Data entry has been re-submitted for review.<br><br>

        <a href="/dashboard">
            <button type="button" class="review-approve">
                Return to Home
            </button>
        </a>
    </div>
</div>

<!-- Error modal -->
<div id="error-approve" class="modal">
    <div class="modal-content">
        <h3>ERROR</h3>
        An error has occurred.<br><br>

        <a href="/dashboard">
            <button type="button" class="review-approve">
                Return to Home
            </button>
        </a>
    </div>
</div>

<script src="/../js/form-step-edit.js" type="text/javascript"></script>
<script src="/../js/locations.js" type="text/javascript"></script>
<script src="/../js/waste-composition-edit.js" type="text/javascript"></script>

<!-- Date picker control -->
<script>
  const startDateInput = document.getElementById('date_start');
  const endDateInput = document.getElementById('date_end');

  startDateInput.addEventListener('input', function () {
    if (startDateInput.value) {
      endDateInput.disabled = false;
      endDateInput.min = startDateInput.value; // Optional: prevent selecting end date before start date
    } else {
      endDateInput.disabled = true;
      endDateInput.value = '';
    }
  });
</script>

<!-- Step 1 validation script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Null guard for waste comp table
  const wasteInputs = document.querySelectorAll("input.waste-entry");

  wasteInputs.forEach(input => {
      // Allow user to type freely (even erase)
      input.addEventListener("input", () => {
          const value = parseFloat(input.value);
          if (!isNaN(value) && value < 0) {
              input.value = 0; // Clamp negatives
          }
      });

      // NEW: On focus, if value is exactly 0, clear it temporarily
      input.addEventListener("focus", () => {
          if (parseFloat(input.value) === 0) {
              input.dataset.wasZero = "true"; // track that we cleared a zero
              input.value = "";
          } else {
              input.dataset.wasZero = "false";
          }
      });

      // On blur, restore 0 if left blank or invalid
      input.addEventListener("blur", () => {
          if (input.value.trim() === "" || isNaN(parseFloat(input.value))) {
              input.value = 0;
          }
          delete input.dataset.wasZero;
      });
  });

  // Prevent accidental submission by pressing Enter
  const form = document.getElementById("waste-form"); // Or use a specific ID if needed

  form.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
        e.preventDefault();
    }
  });

  // Check for any null values on first step
  // Also check if the syntax is correct
  const requiredFields = ['#title', '#regions', '#population', '#per_capita', '#annual', '#date_start', '#date_end'];

  function validateStep1Fields() {
    let allValid = true;

    requiredFields.forEach(selector => {
      const el = document.querySelector(selector);
      const val = el.value.trim();
      const errorEl = document.getElementById('error-' + el.id);
      const touched = el.dataset.touched === 'true';
      let error = '';

      switch (selector) {
        case '#title':
          if (!val) error = 'Title is required.';
          break;

        case '#regions':
          if (!val) error = 'Please select a region.';
          break;

        case '#population':
          if (!val) error = 'Population is required.';
          else if (!/^\d+$/.test(val)) error = 'Population must be a positive whole number.';
          else if (parseInt(val) <= 0) error = 'Population must be greater than zero.';
          break;

        case '#per_capita':
        case '#annual':
          if (!val) error = 'This field is required.';
          else if (isNaN(val)) error = 'Please enter a valid number.';
          else if (parseFloat(val) <= 0) error = 'Value must be a positive number.';
          break;

        case '#date_start':
          if (!val) error = 'Start Date is required.';
          break;

        case '#date_end':
          const startVal = document.querySelector('#date_start').value;
          if (!val) error = 'End Date is required.';
          else if (startVal && val < startVal) error = 'End date cannot be before start date.';
          break;
      }

      // Show or hide error message based on touch status
      if (errorEl) {
        errorEl.textContent = touched ? error : '';
      }

      if (error !== '') allValid = false;
    });

    nextBtn.disabled = !allValid;
    nextBtn.classList.toggle('disabled', !allValid);
  }

  // Add event listeners
  requiredFields.forEach(selector => {
    const el = document.querySelector(selector);
    el.addEventListener('input', validateStep1Fields);
    el.addEventListener('change', validateStep1Fields);
    el.addEventListener('blur', () => {
      el.dataset.touched = 'true';
      validateStep1Fields();
    });
  });

  // Initial state
  validateStep1Fields();

  // Button #modalBtn is disabled while textarea #comment isnâ€™t filled up yet
  const commentInput = document.getElementById("comment");
  const modalBtn = document.getElementById("modalBtn");

  function toggleButton() {
    const trimmedValue = commentInput.value.trim();
    modalBtn.disabled = trimmedValue === "";
  }

  // Initial check
  toggleButton();

  // Listen for changes in the textarea
  commentInput.addEventListener("input", toggleButton);

});
</script>

<!-- Confirmation modal script -->
<script>

// Wait for the DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Modal functionality
    const confirmModal = document.getElementById('confirm-modal');
    const confirmClose = document.getElementById('confirm-close');
    const confirmNo = document.getElementById('confirm-no');

    /* APPROVE MODAL */
    // Hide modal if close btn is clicked
    if (confirmClose) {
        confirmClose.onclick = function() {
            confirmModal.style.display = "none";
        }
    }

    // Hide modal if Cancel button is clicked
    if (confirmNo) {
        confirmNo.onclick = function() {
            confirmModal.style.display = "none";
        }
    }
    
    // Hide modal if user clicks outside content
    window.onclick = function(event) {
        if (event.target == confirmModal) {
            confirmModal.style.display = "none";
        }
    }
})

function showConfirm() {
    document.getElementById('confirm-modal').style.display = 'block';
}

</script>

<style>

#comment {
  width: 100%;
  resize: none;
  font-family: 'Segoe UI', sans-serif;
  font-size: large;
  padding: 10px;
  border-radius: 5px;
  border: 2px solid lightgray;
}

.required {
  color: red;
  margin-left: 4px;
}

.error-msg {
  color: red;
  font-size: 0.9em;
  margin-top: 4px;
}

.upload-btn:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.upload-btn:disabled:hover {
  background-color: #ccc;
  cursor: not-allowed;
}

.instructions-tab {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ddd;
  max-width: 700px;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.instructions-tab h2 {
  font-size: 1.4rem;
  margin-bottom: 1rem;
  color: #2c3e50;
}

.instructions-tab ul {
  list-style: none;
  padding: 0;
}

.instructions-tab li {
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  font-size: 1rem;
}

.instructions-tab li i {
  margin-right: 0.75rem;
  color: #127009;
  width: 20px;
  text-align: center;
}

.download-btn {
  display: inline-block;
  margin-top: 1rem;
  background-color: #28a745;
  color: white;
  padding: 0.6rem 1.2rem;
  text-decoration: none;
  font-weight: 600;
  border-radius: 8px;
  transition: background-color 0.2s ease;
  border: none;
}

.download-btn:hover {
  background-color: #218838;
}

.download-btn i {
  margin-right: 0.5rem;
}

.form-section {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ddd;
  max-width: 1255px;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.form-section h3 {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #2c3e50;
  display: flex;
  align-items: center;
}

.form-section h3 i {
  margin-right: 0.6rem;
  color: #127009;;
}

.form-section label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-section input[type="text"],
.form-section input[type="date"],
.form-section input[type="number"],
.form-section select {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.3rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.upload-btn {
  display: inline-block;
  margin-top: 1rem;
  background-color: #28a745;
  color: white;
  padding: 0.6rem 1.2rem;
  text-decoration: none;
  border-radius: 8px;
  transition: background-color 0.2s ease;
  border: none;
  font-size: 1rem;
  cursor: pointer;
}

.upload-btn:hover {
  background-color: #218838;
}

.upload-btn i {
  margin-right: 0.5rem;
}

.drop-area {
  border: 2px dashed #127009;
  border-radius: 10px;
  padding: 2rem;
  text-align: center;
  color: #2C3927;
  background-color: #f3fff0;
  cursor: pointer;
  position: relative;
  transition: background-color 0.3s ease;
}

.drop-area:hover {
  background-color: #eefff2;
}

.drop-area input[type="file"] {
  opacity: 0;
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  cursor: pointer;
}

.drop-area.highlight {
  background-color: #e8f0ff;
  border-color: #127009;
}

.file-name {
  margin-top: 0.5rem;
  font-style: italic;
  font-size: 0.95rem;
  color: #333;
}

input[type="date"] {
  appearance: none;
  -webkit-appearance: none;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 0.5rem;
  font-size: 1rem;
  width: 100%;
  box-sizing: border-box;
}

.date-input-wrapper {
  position: relative;
  margin-bottom: 1rem;
}

.date-input-wrapper input[type="date"] {
  width: 100%;
  padding: 0.5rem 2.5rem 0.5rem 0.75rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
  appearance: none;
  -webkit-appearance: none;
  background-color: #fff;
  box-sizing: border-box;
}

.date-input-wrapper i {
  position: absolute;
  top: 50%;
  right: 0.75rem;
  transform: translateY(-50%);
  color: #888;
  pointer-events: none;
}

/* -------- Waste Composition Form -------- */
.form-table {
    max-width: 1255px !important;
}

.waste-supertype h3 i {
  color: #28a745;
}

.waste-table-wrapper {
  overflow-x: auto;
  margin-top: 1rem;
}

.waste-table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
  background-color: #fff !important;
}

.waste-table th {
  background-color: #2C3927;
  color: #fff;
  font-weight: bold;
  padding: 0.75rem;
  border: none;
}

.waste-table td {
  padding: 0.5rem;
  border: 1px solid #ddd;
  background-color: #fff !important;
}

.waste-table td:first-child {
  text-align: left;
  font-weight: 500;
  background-color: #eee !important;
  padding-right: 30px;
}

.waste-entry {
  width: 100%; 
     box-sizing: border-box;
     -webkit-box-sizing:border-box;
     -moz-box-sizing: border-box;
  padding: 0.4rem;
  font-size: 0.95rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* -------- Form Steps -------- */
.form-section-label {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ddd;
  max-width: 1255px;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
  text-align: center;
}

.step-labels {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.75rem;
}

.step-labels .label {
  background-color: #f0f0f0;
  color: #333;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  transition: background-color 0.3s ease, color 0.3s ease;
  border: 1px solid #ccc;
}

.step-labels .label.current {
  background-color: #28a745;
  color: white;
  border-color: #28a745;
}

</style>

<!-- Modal style -->
<style>
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 20% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
</style>