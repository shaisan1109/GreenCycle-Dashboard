<!-- Display search parameters -->    
<div id="filter-section" class="filter-section">
    <div class="filter-columns">
        <h3>{{query.title}}</h3>

        <!-- Location Filters -->
        <div class="filter-column">
            <label for="region">Region</label>
            {{query.region}}

            <label for="province">Province</label>
            {{query.province}}

            <label for="municipality">City/Municipality</label>
            {{query.municipality}}

            <label for="barangay">Barangay</label>
            --
        </div>

        <!-- Author & Date Filters -->
        <div class="filter-column">
            <label for="filter-author">Author</label>
            {{query.author}}

            <label for="filter-org">Organization Name</label>
            {{query.company}}

            <label>Collection Date Range</label>
            <div class="date-range">
                {{query.startDate}} to
                {{query.endDate}}
            </div>
        </div>
    </div>
</div>

<!-- Display charts for aggregated data (UPDATE UI FOR THIS) -->
<!-- Title card -->
<fieldset style="width: 97.3%; margin-bottom: 10px; padding-top: 20px; padding-bottom: 20px">
    <h1 style="margin:0">{{fullLocation}}</h1>
</fieldset>

<!-- Initial summary -->
<div style="display: flex;">
    <fieldset style="width: 100%;">
        <legend>Average Waste Generation</legend>

        <table class="user-profile">
            <tr>
                <td class="label">Waste Generation per Capita (Kg/cap-day)</td>
                <td>{{commaNumber avgInfo.avg_per_capita}}</td>
            </tr>
            <tr>
                <td class="label">Annual Waste Generation (kg/year)</td>
                <td>{{commaNumber avgInfo.avg_annual}}</td>
            </tr>
        </table>
    </fieldset>
    
    <fieldset style="width: 100%;">
        <legend>Overall Collection Period</legend>
        <table class="user-profile">
            <tr>
                <td class="label">Start Date</td>
                <td>{{textDate avgInfo.earliest_collection_start}}</td>
            </tr>
            <tr>
                <td class="label">End Date</td>
                <td>{{textDate avgInfo.latest_collection_end}}</td>
            </tr>
        </table>
    </fieldset>
</div>

<!-- Supertype summary pie chart -->
    <div style="display: flex;">
        <div class="pie-chart">
            <canvas id="supertypePieChart">
                <!-- Populated by JS -->
            </canvas>
        </div>

        <div id="summary-legend">
            <h2>Top Waste Categories in This Area</h2>

            {{#each legendData}}
                {{#if (gt value 0)}}
                <span class="legend-item" style="background-color: {{color}}">
                    <span class="legend-name">
                        {{label}}
                        <span class="legend-perc">{{calcPercent value ../legendData}}%</span>
                    </span>
                    <span class="legend-kg">
                        {{toFixed value 3}} kg
                    </span>
                </span>
                {{/if}}
            {{/each}}

            <!-- Toggle showing summary or detailed pie -->
            <button id="togglePieBtn"><i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart</button>
        </div>
    </div>

    <!-- Subtypes bar charts -->
    <hr>
    <br><center><h2>Top Waste Types by Category</h2></center>
    <div class="bar-tab">
        <button class="bar-tablinks" onclick="openBarTab(event, 'Biodegradable')" id="firstBar">BIODEGRADABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Recyclable')">RECYCLABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Residual')">RESIDUAL</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Special/Hazardous')">SPECIAL/HAZARDOUS</button>
    </div>

    <div id="bar-charts-container"></div>

<!-- Pie chart script -->
<script>

/* --------- PIE CHART --------- */
const summaryData = {{{summaryPieData}}};
const detailedData = {{{detailedPieData}}};

let currentMode = 'summary';
const ctx = document.getElementById('supertypePieChart').getContext('2d');

const createPieChart = (data) => {
    return new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: data.backgroundColor,
                hoverOffset: 20
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                callbacks: {
                    label: function (context) {
                        const value = Number(context.raw).toFixed(3);
                        const total = context.chart._metasets[0].total || 1;
                        const percent = ((context.raw / total) * 100).toFixed(3);
                        return `${context.label}: ${value} kg (${percent}%)`;
                    }
                }
                },
                title: {
                    display: false
                },
                legend: {
                    position: 'right'
                }
            }
        }
    });
};

let chart = createPieChart(summaryData, "Waste by Supertype");

document.getElementById('togglePieBtn').addEventListener('click', () => {
    chart.destroy();
    if (currentMode === 'summary') {
        chart = createPieChart(detailedData, "Detailed Waste by Type");
        currentMode = 'detailed';
        togglePieBtn.innerHTML = '<i class="fa-solid fa-chart-pie"></i>&nbsp; Back to Summary Pie Chart';
    } else {
        chart = createPieChart(summaryData, "Waste by Supertype");
        currentMode = 'summary';
        togglePieBtn.innerHTML = '<i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart';
    }
});

/* --------- BAR CHART --------- */

// Build bar chart
const barChartData = {{{barChartData}}};
const container = document.getElementById('bar-charts-container');

for (const [supertype, chartData] of Object.entries(barChartData)) {
    // Create the wrapper tabcontent div
    const tabContentDiv = document.createElement('div');
    tabContentDiv.id = supertype.replace(/\s+/g, '');
    tabContentDiv.classList.add('bar-tabcontent');

    // Create canvas
    const canvas = document.createElement('canvas');
    canvas.id = `barChart-${supertype.replace(/\s+/g, '-')}`;
    canvas.style.maxWidth = '560px';
    canvas.style.marginBottom = '20px';
    tabContentDiv.appendChild(canvas);

    // Create chart wrapper
    const wrapper = document.createElement('div');
    wrapper.classList.add('chart-wrapper');
    wrapper.style.display = 'flex';
    wrapper.style.gap = '24px';
    wrapper.style.alignItems = 'flex-start';
    container.appendChild(wrapper);

    wrapper.appendChild(canvas);

    // Create legend div
    const legendDiv = document.createElement('div');
    legendDiv.classList.add('bar-legend');

    // Create title <h2>
    const legendTitle = document.createElement('h2');
    legendTitle.classList.add('bar-legend-title');
    legendTitle.textContent = `Top ${supertype} Waste Types`;
    legendDiv.appendChild(legendTitle);

    // Generate legend HTML
    legendDiv.innerHTML += chartData.legend
    .filter(item => item.value > 0)
    .map(item => {
        const total = chartData.data.reduce((sum, val) => sum + val, 0);
        const percent = total ? ((item.value / total) * 100).toFixed(3).replace(/\.?0+$/, '') : '0';

        return `<span class="legend-item" style="background-color: ${item.color}">
            <span class="bar-legend-name">
                ${item.label}
                <span class="bar-legend-perc">${percent}%</span>
            </span>
            <span class="bar-legend-kg">
                ${item.value.toFixed(3)} kg
            </span>
        </span>`;
    }).join('');

    // Append title and legend to tab content
    wrapper.appendChild(legendDiv);

    // Append wrapper to tabcontent
    tabContentDiv.appendChild(wrapper);

    // Append everything to main container
    container.appendChild(tabContentDiv);

    // Chart.js setup
    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
            label: `${supertype} Waste Types`,
            data: chartData.data,
            backgroundColor: chartData.legend.map(item => item.color)
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'x',
            plugins: {
            title: {
                display: false
            },
            tooltip: {
                callbacks: {
                label: function(context) {
                    return `${context.parsed.y.toFixed(3)} kg`;
                }
                }
            }
            },
            scales: {
            y: {
                beginAtZero: true,
                title: {
                display: true,
                text: 'Weight (kg)'
                }
            },
            x: {
                ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 20
                }
            }
            }
        }
    });
}

</script>

<!-- Access to chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

.filter-columns {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.filter-column {
  flex: 1 1 300px;
  display: flex;
  flex-direction: column;
}

.filter-column label {
  font-weight: 600;
  margin-top: 0.8rem;
  margin-bottom: 0.3rem;
}

.filter-section {
  background: #fafafa;
  border: 1px solid #ccc;
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

</style>