<!-- Display search parameters if current route has query -->    
<div id="filter-section" class="filter-section" data-section="filters">
    <center>
        <h2 style="margin: 0;">Search Parameters</h2>
    </center>
    <div class="filter-columns">

        <!-- Location Filters -->
        <div class="filter-column">
            <label for="region">Region</label>
            {{regionName}}

            <label for="province">Province</label>
            {{provinceName}}

            <label for="municipality">City/Municipality</label>
            {{municipalityName}}

            <label for="barangay">Barangay</label>
            {{barangayName}}
        </div>

        <!-- Author & Date Filters -->
        <div class="filter-column">
            <label>Title</label>
            {{query.title}} {{#ifEquals query.title undefined}}ALL{{/ifEquals}}

            <label for="filter-author">Author</label>
            {{query.author}} {{#ifEquals query.author undefined}}ALL{{/ifEquals}}

            <label for="filter-org">Organization Name</label>
            {{query.company}} {{#ifEquals query.company undefined}}ALL{{/ifEquals}}

            <label>Collection Date Range</label>
            <div class="date-range">
                {{query.startDate}} {{#ifEquals query.startDate undefined}}--{{/ifEquals}} to
                {{query.endDate}} {{#ifEquals query.endDate undefined}}--{{/ifEquals}}
            </div>
        </div>
    </div>
</div>

<!-- Display charts for aggregated data (UPDATE UI FOR THIS) -->
<!-- Title Card -->
<div class="form-section title-card" style="text-align: center;" data-section="data-title">
    <h1 style="margin-bottom: 0.25rem;">
      GreenCycle Dashboard – Data Summary
    </h1>
    <p style="font-size: large;">Average data for the requested entries.</p>
</div>

<!-- Participants Section -->
<div class="form-section" 
     style="background-color: #f0fff4; padding: 1.5rem; border-radius: 12px; margin: 0.5rem 0;"
     data-section="participants">
  
  <h2 style="color: #2d613f; font-weight: 600; margin-bottom: 1rem;">
    <i class="fa-solid fa-users" style="margin-right: 10px; color: #4CAF50;"></i>
   Participants Included
  </h2>

  <div style="display: flex">
    <!-- Orgs and Users List -->
    <div style="margin-bottom: 1rem; width: 50%">
      <strong style="color:#2d613f;">Organizations & Users:</strong>
      {{#if orgGroups.length}}
        <ul style="padding-left: 1.5rem;">
          {{#each orgGroups}}
            <li>
              <strong>{{company_name}}</strong>
              <ul style="list-style-type: circle; padding-left: 1.5rem; margin: 0.25rem 0;">
                {{#each users}}
                  <li>{{this}}</li>
                {{/each}}
              </ul>
            </li>
          {{/each}}
        </ul>
      {{else}}
        <p style="margin: 0.5rem 0; color: #777;">None</p>
      {{/if}}
    </div>

    <!-- Locations -->
    <div style="width: 50%">
      <strong style="color:#2d613f;">Locations:</strong>
      {{#if uniqueLocations.length}}
        <ul style="list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0;">
          {{#each uniqueLocations}}
            <li style="margin-bottom: 0.25rem; color: #333;">{{this}}</li>
          {{/each}}
        </ul>
      {{else}}
        <p style="margin: 0.5rem 0; color: #777;">None</p>
      {{/if}}
    </div>
  </div>
</div>


<!-- Initial Summary -->
<div style="display: flex;">
  <div data-section="data-info">
    <!-- Waste Generation Info -->
    <div class="form-section">
        <h3><i class="fas fa-dumpster"></i> Waste Generation</h3>
        <table class="user-profile">
        <tr>
            <td class="label">Average Waste Generation per Capita (Kg/cap-day)</td>
            <td>{{commaNumber avgInfo.avg_per_capita}}</td>
        </tr>
        <tr>
            <td class="label">Average Annual Waste Generation (kg/year)</td>
            <td>{{commaNumber avgInfo.avg_annual}}</td>
        </tr>
        </table>
    </div>

    <!-- Collection Info -->
    <div class="form-section">
        <h3><i class="fas fa-calendar-alt"></i> Overall Collection Period</h3>
        <table class="user-profile">
        <tr>
            <td class="label">Earliest Start Date</td>
            <td>{{textDate avgInfo.earliest_collection_start}}</td>
        </tr>
        <tr>
            <td class="label">Latest End Date</td>
            <td>{{textDate avgInfo.latest_collection_end}}</td>
        </tr>
        </table>
    </div>
  </div>

  <!-- Map view -->
  <div id="map" style="margin-bottom: 10px; flex: 1;"></div>
</div>

<div style="display: flex;">
    <!-- Compliance -->
    <div class="form-section" style="background-color: rgb(227, 255, 227); margin: 0 10px 10px 0 !important; width: 100%;" data-section="compliance-category">
      <h2>Waste Category Compliance Status</h2>
            <table class="user-profile">
        <tr>
          <th>Waste Category</th>
          <th>Collected</th>
          <th>Total Generated</th>
          <th>Diversion %</th>
          <th>Target %</th>
          <th>Status</th>
        </tr>
        {{#each wasteCompliances}}
          <tr>
            <td>{{supertype_name}}</td>
            <td>{{formatNumber total_collected_weight}} kg</td>
            <td>{{formatNumber total_generated}} kg</td>
            <td>{{diversion_percentage}}%</td>
            <td>{{target_percentage}}%</td>
            <td>{{compliance_status}}</td>
          </tr>
        {{/each}}
      </table>
    </div>

    <div class="form-section" style="background-color: rgb(227, 255, 227); margin: 0 10px 10px 0 !important; width: 100%;" data-section="compliance-sector">
      <h2>Waste Sector Compliance Status</h2>
            <table class="user-profile">
        <tr>
          <th>Sector Category</th>
          <th>Collected</th>
          <th>Total Generated</th>
          <th>Diversion %</th>
          <th>Target %</th>
          <th>Status</th>
        </tr>
        {{#each sectorCompliances}}
          <tr>
            <td>{{sector_name}}</td>
            <td>{{formatNumber total_collected_weight}} kg</td>
            <td>{{formatNumber total_generated}} kg</td>
            <td>{{diversion_percentage}}%</td>
            <td>{{target_percentage}}%</td>
            <td>{{compliance_status}}</td>
          </tr>
        {{/each}}
      </table>
    </div>
  </div>

<!-- Insight -->
<hr>
<div data-section="insights" class="form-section" style="background-color: #eef8f2; padding: 1.5rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-top: 2rem;">
  <h2 style="color: #2d613f;"><i class="fa-solid fa-lightbulb" style="margin-right: 8px;"></i>General Waste Category Insights & Recommendations</h2>
  <ul style="font-size: 1.1rem; list-style-type: none; padding-left: 0;">
    {{#each recommendations}}
      <li style="margin-bottom: 1rem;">{{{this}}}</li>
    {{/each}}
  </ul>
</div>

<!-- Data Tabs -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Chart')" id="defaultOpen">CHART</button>
</div>

<!-- Display A: Chart -->
<div id="Chart" class="tabcontent">
    <!-- Supertype summary pie chart -->
    <div data-section="top-categories" style="display: flex;">
        <div class="pie-chart">
            <canvas id="supertypePieChart">
                <!-- Populated by JS -->
            </canvas>
        </div>

        <div id="summary-legend">
            <h2>Top Waste Categories in This Area</h2>
            <p style="font-size: large;" id="summary-description">This pie chart shows the distribution of waste by supertype. Each slice represents the total weight (in kilograms) of waste classified as Biodegradable, Recyclable, Residual, or Special/Hazardous. Hover over a slice to view its percentage and absolute weight.</p>

            {{#each legendData}}
                {{#if (gt value 0)}}
                <span class="legend-item" style="background-color: {{color}}">
                    <span class="legend-name">
                        {{label}}
                        <span class="legend-perc">{{calcPercent value ../legendData}}%</span>
                    </span>
                    <span class="legend-kg">
                        {{toFixed value 3}} kg
                    </span>
                </span>
                {{/if}}
            {{/each}}

            <!-- Toggle showing summary or detailed pie -->
            <button id="togglePieBtn"><i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart</button>
        </div>
    </div><br>

    <!-- Subtypes bar charts -->
    <hr>
    <br><center data-section="top-cats">
        <h2>Top Waste Types by Category</h2>
        <p style="font-size: large;">Each bar chart below focuses on one waste category. The bars represent different types under that category, showing how much each contributed to the total weight.</p>
    </center>
    <div class="bar-tab">
        <button class="bar-tablinks" onclick="openBarTab(event, 'Biodegradable')" id="firstBar">BIODEGRADABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Recyclable')">RECYCLABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Residual')">RESIDUAL</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Special/Hazardous')">SPECIAL/HAZARDOUS</button>
    </div>

    <div id="bar-charts-container"></div>

    <!-- Top sectors producing waste -->
    <br><hr><br>
    <div data-section="top-sectors">
      <center>
        <h2>Top Sectors by Waste Output</h2>
        <p style="font-size: large;">This chart shows which economic sectors contribute the most to total waste generation. Use this insight to target waste reduction initiatives by sector.</p>
      </center>
      <div id="sector-chart-container"></div>
    </div>

    <!-- Pie chart per sector -->
    <br><hr><br>
    <center data-section="cats-per-sector">
      <h2>Top Waste Categories per Sector</h2>
      <p style="font-size: large;">Each pie chart below shows the waste composition for a specific economic sector.</p>
    </center>

    <div class="sector-tab">
        <button class="sector-tablinks" onclick="openPieTab(event, 'Residential')" id="firstSector">RESIDENTIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Commercial')">COMMERCIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Institutional')">INSTITUTIONAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Industrial')">INDUSTRIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Health')">HEALTH</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'AgricultureandLivestock')">AGRICULTURE AND LIVESTOCK</button>
    </div>

    <div id="sector-pies-container"></div>
</div>

<!-- Pie chart script -->
<script>

// ========== PIE CHART SETUP ========== //
const summaryData = {{{summaryPieData}}},
      detailedData = {{{detailedPieData}}},
      barChartData = {{{barChartData}}},
      sectorBarData = {{{sectorBarData}}},
      sectorPieData = {{{sectorPieData}}};

const supertypeDemo = {{{supertypeDemo}}};
const grandTotal = {{{grandTotal}}};

/* ----------------------------
  Insight generator (frontend)
  - Uses existing variables:
    summaryData, detailedData, barChartData, sectorPieData,
    sectorBarData, legendData, supertypeDemo, grandTotal, sectorTotals
  - Inserts text into DOM next to charts.
-----------------------------*/

// small helper utilities
const rand = arr => arr[Math.floor(Math.random() * arr.length)];
const pct = (value, total) => total ? (value / total * 100) : 0;
const fmtKg = (n) => `${Number(n).toFixed(3)} kg`;

// phrase banks for variation
const overallPhrases = {
  balanced: [
    "All major categories are nearly proportional, indicating a balanced waste composition with no single dominant source."
  ],
  dominant: [
    "One category dominates the waste stream. Prioritize source reduction and targeted segregation for this category."
  ],
  lowReported: [
    "Some categories show very low or missing volumes. This may be caused by underreporting, misclassification, gaps in reporting, or genuinely low output."
  ],
  mixedDominant: [
    "Several categories contribute significant amounts. Consider combined campaigns (e.g., recycling + organics) rather than programs for a single type."
  ]
};

// dynamic insight generators
// ---------------- OVERALL INSIGHT ----------------
function generateOverallInsight(supertypeMapObj, grandTotalVal) {
  const supertypes = Object.values(supertypeMapObj);
  const nonzero = supertypes.filter(s => Number(s.totalWeight) > 0);
  const shares = supertypes.map(s => ({
    name: s.name,
    value: Number(s.totalWeight),
    pct: pct(Number(s.totalWeight), grandTotalVal)
  }));
  shares.sort((a,b)=>b.pct-a.pct);

  if (grandTotalVal === 0) {
    return "No waste data recorded for this entry. Please verify and recheck data submissions.";
  }

  const top = shares[0];
  const second = shares[1] || null;
  const avgPct = shares.reduce((a,b)=>a+b.pct,0)/shares.length;
  const deviations = shares.map(s => Math.abs(s.pct - avgPct));
  const allBalanced = deviations.every(d => d < 5); // 5% deviation tolerance

  // CASE 1: Evenly distributed
  if (allBalanced && nonzero.length > 2) {
    let text = rand(overallPhrases.balanced);
    const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
    if (lowList.length) text += ` However, some categories appear minimal: ${lowList.join(', ')}.`;
    return text;
  }

  // CASE 2: One dominant
  if (top.pct >= 50) {
    let text = `${rand(overallPhrases.dominant)} Currently, <strong>${top.name}</strong> represents ${top.pct.toFixed(1)}% of the total.`;
    const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
    if (lowList.length) text += ` Some low categories: ${lowList.join(', ')}.`;
    return text;
  }

  // CASE 3: Multiple dominate
  const strongList = shares.filter(s => s.pct >= 20);
  if (strongList.length >= 2 && strongList.length < shares.length) {
    let text = `${rand(overallPhrases.mixedDominant)} <br><b>Major categories: ${strongList.map(s => s.name).join(', ')}</b>`;
    const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
    if (lowList.length) text += ` Underrepresented: ${lowList.join(', ')}.`;
    return text;
  }

  // CASE 4: Mainly low/underreported
  const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
  if (lowList.length === shares.length) {
    return "All categories show minimal values — likely incomplete or unreported data.";
  }
  if (lowList.length) {
    return `${rand(overallPhrases.lowReported)} Notably low: ${lowList.join(', ')}.`;
  }

  // Default
  return "The waste composition shows a mixed pattern without extreme concentrations. Continue tracking for shifts over time.";
}

// ---------------- SUPERTYPE DETAIL INSIGHT ----------------
function generateSupertypeInsight(supertypeObj, grandTotalVal) {
  const types = supertypeObj.types || [];
  const total = Number(supertypeObj.totalWeight) || 0;
  if (!total || !types.length) {
    return `No data recorded for <strong>${supertypeObj.name}</strong>. Verify reporting for this category.`;
  }

  const pairs = types.map(t => ({
    name: t.name,
    value: Number(t.weight),
    pct: pct(Number(t.weight), total)
  })).sort((a,b)=>b.pct - a.pct);

  const top = pairs[0];
  const second = pairs[1] || null;
  const avgPct = pairs.reduce((a,b)=>a+b.pct,0)/pairs.length;
  const allBalanced = pairs.every(p => Math.abs(p.pct - avgPct) < 5);
  const lowList = pairs.filter(p => p.pct < 2).map(p => p.name);

  // Even distribution
  if (allBalanced && pairs.length > 2) {
    let text = `Types under <strong>${supertypeObj.name}</strong> are evenly distributed.`;
    if (lowList.length) text += ` Some appear underreported: ${lowList.join(', ')}.`;
    return text;
  }

  // One dominant
  if (top.pct >= 50) {
    let text = `<strong>${top.name}</strong> dominates this category (${top.pct.toFixed(1)}%).`;
    if (lowList.length) text += ` Low types: ${lowList.join(', ')}.`;
    return text;
  }

  // Multiple dominant
  const highList = pairs.filter(p => p.pct >= 20);
  if (highList.length >= 2 && highList.length < pairs.length) {
    let text = `Several types stand out within <strong>${supertypeObj.name}</strong>: ${highList.map(p=>p.name).join(', ')}.`;
    if (lowList.length) text += ` Underreported types: ${lowList.join(', ')}.`;
    return text;
  }

  // Mostly low
  if (lowList.length) {
    return `Most types under <strong>${supertypeObj.name}</strong> are minimal — likely low generation or incomplete entries (${lowList.join(', ')}).`;
  }

  // Default
  return `The <strong>${supertypeObj.name}</strong> category shows varied distribution across its types.`;
}

// ---------------- SECTOR INSIGHT (per sector) ----------------
function generateSectorInsight(sectorName, pieDataForSector, sectorTotalValue, grandTotalVal) {
  const labels = pieDataForSector.labels || [];
  const data = pieDataForSector.data || [];
  const pairs = labels.map((l,i) => ({
    label: l,
    value: data[i],
    pct: pct(data[i], sectorTotalValue)
  }));
  pairs.sort((a,b)=>b.pct-a.pct);

  if (sectorTotalValue === 0) {
    return `${sectorName} has no recorded waste. Please check reporting completeness.`;
  }

  const avgPct = pairs.reduce((a,b)=>a+b.pct,0)/pairs.length;
  const allBalanced = pairs.every(p => Math.abs(p.pct - avgPct) < 5);
  const top = pairs[0];
  const second = pairs[1] || null;
  const lowList = pairs.filter(p => p.pct < 2).map(p => p.label);

  let insight = '';

  // Even
  if (allBalanced && pairs.length > 2) {
    insight = `Waste in the ${sectorName} sector is evenly distributed among categories.`;
  }
  // One dominates
  else if (top.pct >= 50) {
    insight = `<strong>${top.label}</strong> dominates waste in the ${sectorName} sector (${top.pct.toFixed(1)}%).`;
  }
  // Multiple dominate
  else if (pairs.filter(p=>p.pct>=20).length >= 2) {
    const majors = pairs.filter(p=>p.pct>=20).map(p=>p.label);
    insight = `Dominant waste types in the <b>${sectorName}</b> sector: ${majors.join(', ')}.`;
  }
  // Default
  else {
    insight = `The ${sectorName} sector has mixed contributions across categories.`;
  }

  // Always check for low items
  if (lowList.length) {
    insight += ` Some categories are very low (<2%): ${lowList.join(', ')}.`;
  }

  return insight;
}

/* --------------------
  Insert generated insights into DOM near chart areas.
  - For the main pie: insert under #summary-legend (you already have that div)
  - For each supertype bar tab: insert into the tab's wrapper (we create .insight-box)
  - For each sector pie: insert into the sector wrapper
--------------------*/

function insertOverallInsight() {
  try {
    const overallText = generateOverallInsight(supertypeDemo || {}, Number(grandTotal || 0));
    const container = document.getElementById('summary-description');

    if (container) {
      let box = container.querySelector('.insight-box.overall');
      if (!box) {
        box = document.createElement('div');
        box.className = 'insight-box overall';
        box.style = 'margin-top:1rem; padding:1rem; border-left:4px solid #2e7d32;background:#f7fff8; border-radius:6px;';
        container.appendChild(box);
      }
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">Quick Recommendation</h3><div>${overallText}</div>`;
    }
  } catch (err) {
    console.error('Overall insight generation failed', err);
  }
}

// call after page loads and charts generated
function insertPerSupertypeInsights() {
  try {
    const superMap = supertypeDemo || {};
    for (const sv of Object.values(superMap)) {
      const id = sv.name.replace(/\s+/g, '');
      const wrapper = document.getElementById(id); // matches how you set tabDiv.id earlier

      if (!wrapper) continue;

      let box = wrapper.querySelector('.bar-description');
      if (!box) {
        box = document.createElement('div');
        wrapper.appendChild(box);
      }
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">${sv.name} Category</h3><div>${generateSupertypeInsight(sv, Number(grandTotal || 0))}</div>`;
    }
  } catch (err) { console.error(err); }
}

function insertSectorInsights() {
  try {
    for (const [sectorName, pieData] of Object.entries(sectorPieData || {})) {
      const id = sectorName.replace(/\s+/g, '');
      const wrapper = document.getElementById(id);

      if (!wrapper) continue;
      let box = wrapper.querySelector('.sector-pie-desc');

      if (!box) {
        box = document.createElement('div');
        wrapper.appendChild(box);
      }
      const sectorTotalVal = (sectorBarData || []).find(s=>s.label===sectorName)?.value || 0;
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">${sectorName} Sector</h3><div>${generateSectorInsight(sectorName, pieData, Number(sectorTotalVal || 0), Number(grandTotal || 0))}</div>`;
    }
  } catch (err) { console.error(err); }
}

// sector overview (for the "Waste by Sector" horizontal bar chart)
function generateSectorOverviewInsight(sectorBarArr, grandTotalVal) {
  const validSectors = (sectorBarArr || []).filter(s => Number(s.value) > 0);
  if (!validSectors.length || grandTotalVal === 0) {
    return "No sector data recorded. Please verify that sector totals were generated correctly.";
  }

  const shares = validSectors.map(s => ({
    name: s.label,
    value: Number(s.value),
    pct: pct(Number(s.value), grandTotalVal)
  }));
  shares.sort((a, b) => b.pct - a.pct);

  const top = shares[0];
  const second = shares[1] || null;
  const topPct = top ? top.pct : 0;

  // Case 1: No data
  if (grandTotalVal === 0) {
    return "No waste totals found. Cannot determine sector distribution.";
  }

  // Case 2: Even / balanced spread
  if (topPct < 30 && validSectors.length >= 3) {
    return "Waste generation is fairly balanced across sectors; no single area stands out as dominant.";
  }

  // Case 3: One sector overwhelmingly dominant
  if (topPct >= 50) {
    return `<strong>${top.name}</strong> is the largest contributor, producing ${top.pct.toFixed(1)}% of all recorded waste.`;
  }

  // Case 4: Two or more sectors are high and close
  if (topPct >= 30 && topPct < 50 && second && (top.pct - second.pct) < 10) {
    return `Waste generation is shared across multiple sectors, led by <strong>${top.name}</strong> and <strong>${second.name}</strong>.`;
  }

  // Case 5: Some sectors appear low or missing
  const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
  if (lowList.length) {
    return `Some sectors show minimal contribution (< 2%): ${lowList.join(', ')}.`;
  }

  // Default / fallback
  return "Sector contributions appear proportionate. Continue monitoring to identify future trends.";
}

function insertSectorOverviewInsight() {
  try {
    const container = document.getElementById('sector-chart-container');
    if (!container) return;

    const insightText = generateSectorOverviewInsight(sectorBarData || [], Number(grandTotal || 0));
    
    let box = container.querySelector('.sector-overview');
    if (!box) {
      box = document.createElement('div');
      container.appendChild(box);
    }

    box.innerHTML = `
      <h3 style="margin:0 0 0.25rem 0;color:#2d613f">Sector Overview</h3>
      <div>${insightText}</div>
    `;
  } catch (err) {
    console.error('Sector overview insight generation failed', err);
  }
}

let currentMode = 'summary';
const ctx = document.getElementById('supertypePieChart').getContext('2d');

const createPieChart = data => new Chart(ctx, {
  type: 'pie',
  data: {
    labels: data.labels,
    datasets: [{
      data: data.data,
      backgroundColor: data.backgroundColor,
      hoverOffset: 20
    }]
  },
  options: {
    responsive: true,
    plugins: {
      tooltip: {
        callbacks: {
          label: ({ raw, label, chart }) => {
            const total = chart._metasets[0].total || 1;
            const percent = ((raw / total) * 100).toFixed(3);
            return `${label}: ${Number(raw).toFixed(3)} kg (${percent}%)`;
          }
        }
      },
      legend: { position: 'right' },
      title: { display: false }
    }
  }
});

let chart = createPieChart(summaryData);

document.getElementById('togglePieBtn').addEventListener('click', () => {
  chart.destroy();
  currentMode = currentMode === 'summary' ? 'detailed' : 'summary';
  chart = createPieChart(currentMode === 'summary' ? summaryData : detailedData);
  togglePieBtn.innerHTML = currentMode === 'summary'
    ? '<i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart'
    : '<i class="fa-solid fa-chart-pie"></i>&nbsp; Back to Summary Pie Chart';
});


// ========== SHARED BAR CHART LEGEND FUNCTION ========== //
const createLegendHTML = (legendData, dataset) => {
  const total = dataset.reduce((a, b) => a + b, 0);
  return legendData
    .filter(item => item.value > 0)
    .map(item => {
      const pct = total ? ((item.value / total) * 100).toFixed(3).replace(/\.0+$/, '') : '0';
      return `<span class="legend-item" style="background-color: ${item.color}">
        <span class="bar-legend-name">
          ${item.label}
          <span class="bar-legend-perc">${pct}%</span>
        </span>
        <span class="bar-legend-kg">
          ${item.value.toFixed(3)} kg
        </span>
      </span>`;
    }).join('');
};


// ========== BAR CHARTS BY WASTE TYPE ========== //
const container = document.getElementById('bar-charts-container');

for (const [supertype, chartData] of Object.entries(barChartData)) {
  const tabDiv = document.createElement('div');
  tabDiv.id = supertype.replace(/\s+/g, '');
  tabDiv.classList.add('bar-tabcontent');
  tabDiv.setAttribute('data-section', `types-${supertype.toLowerCase()}`);

  const canvas = document.createElement('canvas');
  canvas.id = `barChart-${supertype.replace(/\s+/g, '-')}`;
  canvas.style.maxWidth = '700px';
  canvas.style.marginBottom = '20px';

  const wrapper = document.createElement('div');
  wrapper.classList.add('chart-wrapper');
  wrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';

  const legendDiv = document.createElement('div');
  legendDiv.classList.add('bar-legend');
  legendDiv.innerHTML = `<h2 class="bar-legend-title">Top ${supertype} Waste Types</h2>` +
    `<div class='bar-description' style='background-color: #eef8f2; padding: 1rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 1rem; width: fit-content'></div>` + 
    createLegendHTML(chartData.legend, chartData.data);

  wrapper.append(canvas, legendDiv);
  tabDiv.appendChild(wrapper);
  container.appendChild(tabDiv);

  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: `${supertype} Waste Types`,
        data: chartData.data,
        backgroundColor: chartData.legend.map(i => i.color)
      }]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      indexAxis: 'x',
      plugins: {
        tooltip: {
          callbacks: {
            label: ({ parsed }) => `${parsed.y.toFixed(3)} kg`
          }
        },
        title: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Weight (kg)' }
        },
        x: {
          ticks: { autoSkip: false, maxRotation: 45, minRotation: 20 }
        }
      }
    }
  });
}


// ========== SECTOR BAR CHART ========== //
const tsContainer = document.getElementById('sector-chart-container');

const tsCanvas = document.createElement('canvas');
tsCanvas.id = 'sectorBarChart';
tsCanvas.style.maxWidth = '700px';
tsCanvas.style.marginBottom = '20px';

const tsWrapper = document.createElement('div');
tsWrapper.classList.add('chart-wrapper');
tsWrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';
tsWrapper.appendChild(tsCanvas);
tsContainer.appendChild(tsWrapper);

const sectorLabels = sectorBarData.map(i => i.label),
      sectorValues = sectorBarData.map(i => i.value),
      sectorColors = sectorBarData.map(i => i.color);

new Chart(tsCanvas.getContext('2d'), {
  type: 'bar',
  data: {
    labels: sectorLabels,
    datasets: [{
      label: 'Waste by Sector',
      data: sectorValues,
      backgroundColor: sectorColors
    }]
  },
  options: {
    responsive: true,
    indexAxis: 'y',
    plugins: {
      tooltip: {
        callbacks: {
          label: ({ parsed }) => `${parsed.x.toFixed(3)} kg`
        }
      },
      title: { display: false }
    },
    scales: {
      y: { beginAtZero: true, title: { display: true, text: 'Weight (kg)' } },
      x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 20 } }
    }
  }
});

const tsLegendDiv = document.createElement('div');
tsLegendDiv.classList.add('bar-legend');
tsLegendDiv.innerHTML = `<div class='sector-overview' style='margin-top:1rem; padding:1rem; border-left:4px solid #2e7d32;background:#f7fff8; border-radius:6px; margin-bottom: 1rem'></div>` + createLegendHTML(sectorBarData, sectorValues);
const tsLegendWrapper = document.createElement('div');
tsLegendWrapper.appendChild(tsLegendDiv);
tsWrapper.appendChild(tsLegendWrapper);


// ========== SECTOR PIE CHARTS ========== //
const sectorContainer = document.getElementById('sector-pies-container');

for (const [sectorName, pieData] of Object.entries(sectorPieData)) {
  const tabDiv = document.createElement('div');
  tabDiv.id = sectorName.replace(/\s+/g, '');
  tabDiv.classList.add('sector-tabcontent');
  tabDiv.setAttribute('data-section', `top-${sectorName.toLowerCase()}`);

  const canvas = document.createElement('canvas');
  canvas.id = `pieChart-${sectorName.replace(/\s+/g, '-')}`;
  canvas.style.cssText = 'max-width:625px; max-height:600px; margin-bottom:20px; margin-left: 30px';

  const wrapper = document.createElement('div');
  wrapper.classList.add('chart-wrapper');
  wrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';

  const legendDiv = document.createElement('div');
  legendDiv.classList.add('bar-legend');
  legendDiv.innerHTML = `
    <h2 class="bar-legend-title">${sectorName} Sector</h2>` +
    `<div class='sector-pie-desc' style='background-color: #eef8f2; padding: 1rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 1rem; width: fit-content'></div>` + 
    createLegendHTML(pieData.labels.map((label, i) => ({
      label,
      value: pieData.data[i],
      color: pieData.backgroundColor[i]
    })), pieData.data);

  wrapper.append(canvas, legendDiv);
  tabDiv.appendChild(wrapper);
  sectorContainer.appendChild(tabDiv);

  new Chart(canvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: pieData.labels,
      datasets: [{
        data: pieData.data,
        backgroundColor: pieData.backgroundColor,
        hoverOffset: 20
      }]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ({ raw }) => {
              const total = pieData.data.reduce((a, b) => a + b, 0);
              const pct = total ? ((raw / total) * 100).toFixed(3).replace(/\.0+$/, '') : '0';
              return `${raw.toFixed(3)} kg (${pct}%)`;
            }
          }
        },
        legend: { position: 'right' },
        title: { display: false }
      }
    }
  });
}

// call these after charts are rendered
insertOverallInsight();
insertPerSupertypeInsights();
insertSectorInsights();
insertSectorOverviewInsight();

</script>

<!-- Map view script -->
<script>
  // Parse from server
  const locations = {{{locations}}}; // coords

  // If no valid points, show alert or center at a default
  if (locations.length === 0) {
    alert("No coordinates available for the selected filters.");
  } else {
    const map = L.map('map').setView([locations[0].latitude, locations[0].longitude], 0); // Initial center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const bounds = [];

    locations.forEach(loc => {
      if (loc.latitude && loc.longitude) {
        const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
        bounds.push([loc.latitude, loc.longitude]);
      }
    });

    // Auto-zoom to fit all pins
    if (bounds.length > 0) {
      map.fitBounds(bounds, {
        padding: [50, 50] // Adds padding around the edges (in pixels)
      });
    }
  }
</script>

<!-- Access to chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Leaflet.js (for map view) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- JS behind the tabs -->
<script src="/js/tabs.js"></script>
<script src="/js/tabs-bar.js"></script>
<script src="/js/tabs-sector-pie.js"></script>

<style>

.filter-columns {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.filter-column {
  flex: 1 1 300px;
  display: flex;
  flex-direction: column;
}

.filter-column label {
  font-weight: 600;
  margin-top: 0.8rem;
  margin-bottom: 0.3rem;
}

.filter-section {
  background: #fafafa;
  border: 1px solid #ccc;
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

.info-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.info-grid .form-section {
  flex: 1 1 280px;
  min-width: 280px;
}

.user-profile {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
}

.user-profile td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid #eee;
}

.user-profile .label {
  font-weight: 600;
  color: #444;
  width: 50%;
}

.title-card h1 {
  font-size: 1.75rem;
}

.btn-submit {
  background-color: #28a745;
  border: none;
  padding: 0.6rem 1.2rem;
  color: white;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.2s ease;
}

.btn-submit:hover {
  background-color: #28a745;
}

.tab-new {
  text-align: center;
  margin-top: 2rem;
}

.tab-new button {
  background-color: #f1f1f1;
  border: none;
  padding: 0.75rem 1.5rem;
  margin: 0 5px;
  cursor: pointer;
  font-weight: 600;
  border-radius: 8px;
  transition: background-color 0.2s;
}

.tab-new button:hover,
.tab-new button.active {
  background-color: #d0e6ff;
}

.form-section {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.form-section h3 {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #2c3e50;
  align-items: center;
}

.form-section h3 i {
  margin-right: 0.6rem;
  color: #127009;;
}

.form-section label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-section input[type="text"],
.form-section input[type="date"],
.form-section input[type="number"],
.form-section select {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.3rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.pie-legend {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 12px;
}

.high-priority {
  color: #127009;
  background-color: #c2f3ce;
  padding: 0.75rem;
  border-left: 4px solid #127009;
  border-radius: 6px;
  display: block;
}

.mid-priority {
  color: #cc7a00;
  background-color: #fff4e0;
  padding: 0.75rem;
  border-left: 4px solid #cc7a00;
  border-radius: 6px;
  display: block;
}

.low-priority {
  color: #b30000;
  background-color: #ffe6e6;
  padding: 0.75rem;
  border-left: 4px solid #b30000;
  border-radius: 6px;
  display: block;
}

</style>