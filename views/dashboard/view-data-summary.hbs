<!-- Display search parameters if current route has query -->    
<div id="filter-section" class="filter-section" data-section="filters">
    <center>
        <h2 style="margin: 0;">Search Parameters</h2>
    </center>
    <div class="filter-columns">

        <!-- Location Filters -->
        <div class="filter-column">
            <label for="region">Region</label>
            {{regionName}}

            <label for="province">Province</label>
            {{provinceName}}

            <label for="municipality">City/Municipality</label>
            {{municipalityName}}

            <label for="barangay">Barangay</label>
            {{barangayName}}
        </div>

        <!-- Author & Date Filters -->
        <div class="filter-column">
            <label>Title</label>
            {{query.title}} {{#ifEquals query.title undefined}}ALL{{/ifEquals}}

            <label for="filter-author">Author</label>
            {{query.author}} {{#ifEquals query.author undefined}}ALL{{/ifEquals}}

            <label for="filter-org">Organization Name</label>
            {{query.company}} {{#ifEquals query.company undefined}}ALL{{/ifEquals}}

            <label>Collection Date Range</label>
            <div class="date-range">
                {{query.startDate}} {{#ifEquals query.startDate undefined}}--{{/ifEquals}} to
                {{query.endDate}} {{#ifEquals query.endDate undefined}}--{{/ifEquals}}
            </div>
        </div>

        <!-- Additional Metrics Filters -->
        <div class="filter-column">
            <label>Waste Type</label>
            {{query.wasteType}} {{#ifEquals query.wasteType undefined}}ALL{{/ifEquals}}

            <label>Status</label>
            {{query.status}} {{#ifEquals query.status undefined}}ALL{{/ifEquals}}

            <label>Sector</label>
            {{query.sector}} {{#ifEquals query.sector undefined}}ALL{{/ifEquals}}
        </div>
    </div>

    <!-- Button to open modal -->
    <div style="text-align: center; margin-top: 1.5rem;">
        <button id="customizeReportBtn" class="btn-customize">
            <i class="fa-solid fa-sliders"></i> Customize Report Parameters
        </button>
    </div>
</div>

<!-- Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: #fff;"><i class="fa-solid fa-chart-line"></i> Customize Report Parameters</h2>
            <span class="close">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Current Filters -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #2d613f; margin-bottom: 0.5rem;"><i class="fa-solid fa-filter"></i> Current Filters Applied:</h3>
                <div class="filter-tags">
                    {{#if regionName}}<span class="filter-tag">Region: {{regionName}}</span>{{/if}}
                    {{#if provinceName}}<span class="filter-tag">Province: {{provinceName}}</span>{{/if}}
                    {{#if municipalityName}}<span class="filter-tag">City: {{municipalityName}}</span>{{/if}}
                    {{#if query.startDate}}<span class="filter-tag">From: {{query.startDate}}</span>{{/if}}
                    {{#if query.endDate}}<span class="filter-tag">To: {{query.endDate}}</span>{{/if}}
                    {{#if query.aggregation}}<span class="filter-tag">Aggregation: {{query.aggregation}}</span>{{/if}}
                </div>
            </div>

            <hr>

            <!-- Additional Filters -->
            <h3 style="color: #2d613f; margin-bottom: 1rem;"><i class="fa-solid fa-sliders"></i> Additional Metric Filters:</h3>
            <div class="filter-grid">
                <div>
                    <label><i class="fa-solid fa-recycle"></i> Waste Type</label>
                    <select id="modal-wasteType">
                        <option value="">All Types</option>
                        <option value="Biodegradable" {{#ifEquals query.wasteType "Biodegradable"}}selected{{/ifEquals}}>Biodegradable</option>
                        <option value="Recyclable" {{#ifEquals query.wasteType "Recyclable"}}selected{{/ifEquals}}>Recyclable</option>
                        <option value="Residual" {{#ifEquals query.wasteType "Residual"}}selected{{/ifEquals}}>Residual</option>
                        <option value="Special/Hazardous" {{#ifEquals query.wasteType "Special/Hazardous"}}selected{{/ifEquals}}>Special/Hazardous</option>
                    </select>
                </div>

                <div>
                    <label><i class="fa-solid fa-building"></i> Sector</label>
                    <select id="modal-sector">
                        <option value="">All Sectors</option>
                        <option value="Residential" {{#ifEquals query.sector "Residential"}}selected{{/ifEquals}}>Residential</option>
                        <option value="Commercial" {{#ifEquals query.sector "Commercial"}}selected{{/ifEquals}}>Commercial</option>
                        <option value="Institutional" {{#ifEquals query.sector "Institutional"}}selected{{/ifEquals}}>Institutional</option>
                        <option value="Industrial" {{#ifEquals query.sector "Industrial"}}selected{{/ifEquals}}>Industrial</option>
                        <option value="Health" {{#ifEquals query.sector "Health"}}selected{{/ifEquals}}>Health</option>
                        <option value="Agriculture and Livestock" {{#ifEquals query.sector "Agriculture and Livestock"}}selected{{/ifEquals}}>Agriculture and Livestock</option>
                    </select>
                </div>

                <div>
                    <label><i class="fa-solid fa-check-circle"></i> Compliance Status</label>
                    <select id="modal-compliance">
                        <option value="">All Entries</option>
                        <option value="compliant" {{#ifEquals query.compliance "compliant"}}selected{{/ifEquals}}>Compliant Only</option>
                        <option value="non-compliant" {{#ifEquals query.compliance "non-compliant"}}selected{{/ifEquals}}>Non-Compliant Only</option>
                    </select>
                </div>

                <div>
                    <label><i class="fa-solid fa-calendar-days"></i> Time Aggregation</label>
                    <select id="modal-aggregation">
                        <option value="daily" {{#ifEquals query.aggregation "daily"}}selected{{/ifEquals}}>Daily Summary</option>
                        <option value="weekly" {{#ifEquals query.aggregation "weekly"}}selected{{/ifEquals}}>Weekly Summary</option>
                        <option value="monthly" {{#ifEquals query.aggregation "monthly"}}selected{{/ifEquals}}>Monthly Summary</option>
                    </select>
                </div>
            </div>

            <hr>

            <!-- Metrics to Include -->
            <h3 style="color: #2d613f; margin-bottom: 1rem;"><i class="fa-solid fa-list-check"></i> Sections to Include in Report:</h3>
            <div class="checkbox-grid">
                <label>
                    <input type="checkbox" name="section" value="participants" checked>
                    <span><i class="fa-solid fa-users"></i> Participants</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="data-info" checked>
                    <span><i class="fa-solid fa-dumpster"></i> Waste Generation</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="trends" checked>
                    <span><i class="fa-solid fa-chart-line"></i> Trends Over Time</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="compliance-category" checked>
                    <span><i class="fa-solid fa-clipboard-check"></i> Category Compliance</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="compliance-sector" checked>
                    <span><i class="fa-solid fa-industry"></i> Sector Compliance</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="insights" checked>
                    <span><i class="fa-solid fa-lightbulb"></i> Insights</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="top-categories" checked>
                    <span><i class="fa-solid fa-chart-pie"></i> Top Categories Chart</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="top-cats" checked>
                    <span><i class="fa-solid fa-chart-bar"></i> Category Breakdown</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="top-sectors" checked>
                    <span><i class="fa-solid fa-chart-column"></i> Top Sectors Chart</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="cats-per-sector" checked>
                    <span><i class="fa-solid fa-chart-simple"></i> Sector Breakdown</span>
                </label>
                <label>
                    <input type="checkbox" name="section" value="map" checked>
                    <span><i class="fa-solid fa-map-location-dot"></i> Location Map</span>
                </label>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" id="resetBtn">
                <i class="fa-solid fa-rotate-left"></i> Reset to Default
            </button>
            <button class="btn-secondary" id="exportPdfBtn">
                <i class="fa-solid fa-file-pdf"></i> Export as PDF
            </button>
            <button class="btn-secondary" id="cancelBtn">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button class="btn-primary" id="applyBtn">
                <i class="fa-solid fa-check"></i> Apply Filters
            </button>
        </div>
    </div>
</div>

<!-- Display charts for aggregated data -->
<!-- Title Card -->
<div class="form-section title-card" style="text-align: center;" data-section="data-title">
    <h1 style="margin-bottom: 0.25rem;">
      GreenCycle Dashboard â€“ Data Summary
    </h1>
    <p style="font-size: large;">
        {{#if query.aggregation}}
            {{#ifEquals query.aggregation "daily"}}Daily{{/ifEquals}}
            {{#ifEquals query.aggregation "weekly"}}Weekly{{/ifEquals}}
            {{#ifEquals query.aggregation "monthly"}}Monthly{{/ifEquals}}
            aggregated data for the requested entries.
        {{else}}
            Overall summary data for the requested entries.
        {{/if}}
    </p>
</div>

<!-- Participants Section -->
<div class="form-section" 
     style="background-color: #f0fff4; padding: 1.5rem; border-radius: 12px; margin: 0.5rem 0;"
     data-section="participants">
  
  <h2 style="color: #2d613f; font-weight: 600; margin-bottom: 1rem;">
    <i class="fa-solid fa-users" style="margin-right: 10px; color: #4CAF50;"></i>
   Participants Included
  </h2>

  <div style="display: flex">
    <!-- Orgs and Users List -->
    <div style="margin-bottom: 1rem; width: 50%">
      <strong style="color:#2d613f;">Organizations & Users:</strong>
      {{#if orgGroups.length}}
        <ul style="padding-left: 1.5rem;">
          {{#each orgGroups}}
            <li>
              <strong>{{company_name}}</strong>
              <ul style="list-style-type: circle; padding-left: 1.5rem; margin: 0.25rem 0;">
                {{#each users}}
                  <li>{{this}}</li>
                {{/each}}
              </ul>
            </li>
          {{/each}}
        </ul>
      {{else}}
        <p style="margin: 0.5rem 0; color: #777;">None</p>
      {{/if}}
    </div>

    <!-- Locations -->
    <div style="width: 50%">
      <strong style="color:#2d613f;">Locations:</strong>
      {{#if uniqueLocations.length}}
        <ul style="list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0;">
          {{#each uniqueLocations}}
            <li style="margin-bottom: 0.25rem; color: #333;">{{this}}</li>
          {{/each}}
        </ul>
      {{else}}
        <p style="margin: 0.5rem 0; color: #777;">None</p>
      {{/if}}
    </div>
  </div>
</div>


<!-- Initial Summary -->
<div style="display: flex;">
  <div data-section="data-info">
    <!-- Waste Generation Info -->
    <div class="form-section">
        <h3><i class="fas fa-dumpster"></i> Waste Generation</h3>
        <table class="user-profile">
        <tr>
            <td class="label">Average Waste Generation per Capita (Kg/cap-day)</td>
            <td>{{commaNumber avgInfo.avg_per_capita}}</td>
        </tr>
        <tr>
            <td class="label">Average Annual Waste Generation (kg/year)</td>
            <td>{{commaNumber avgInfo.avg_annual}}</td>
        </tr>
        </table>
    </div>

    <!-- Collection Info -->
    <div class="form-section">
        <h3><i class="fas fa-calendar-alt"></i> Overall Collection Period</h3>
        <table class="user-profile">
        <tr>
            <td class="label">Earliest Start Date</td>
            <td>{{textDate avgInfo.earliest_collection_start}}</td>
        </tr>
        <tr>
            <td class="label">Latest End Date</td>
            <td>{{textDate avgInfo.latest_collection_end}}</td>
        </tr>
        </table>
    </div>
  </div>

  <!-- Map view -->
  <div id="map" style="margin-bottom: 10px; flex: 1;" data-section="map"></div>
</div>

<!-- NEW: Trends Over Time Section -->
<div class="form-section" style="background-color: #f8f9ff; padding: 2rem; border-radius: 12px; border-left: 6px solid #2196F3;" data-section="trends">
  <h2 style="color: #1565C0; font-weight: 600; margin-bottom: 1rem; display: flex">
    <i class="fa-solid fa-chart-line" style="margin-right: 10px; color: #2196F3;"></i>
    Trends Over Time

    <span style="font-size: 0.9rem; color: #666; font-weight: 400;">
      ({{#ifEquals query.aggregation "daily"}}Daily{{/ifEquals}}{{#ifEquals query.aggregation "weekly"}}Weekly{{/ifEquals}}{{#ifEquals query.aggregation "monthly"}}Monthly{{/ifEquals}} View)
    </span>

    <!-- Aggregation settings -->
    <select id="select-aggregation" style="margin-left: auto; width: 200px;">
      <option value="daily" {{#ifEquals query.aggregation "daily"}}selected{{/ifEquals}}>Daily Summary</option>
      <option value="weekly" {{#ifEquals query.aggregation "weekly"}}selected{{/ifEquals}}>Weekly Summary</option>
      <option value="monthly" {{#ifEquals query.aggregation "monthly"}}selected{{/ifEquals}}>Monthly Summary</option>
    </select>&nbsp;

    <button class="btn-primary" id="applyBtn">
      <i class="fa-solid fa-check"></i> Apply Filters
    </button>
  </h2>
  
  <p style="color: #555; margin-bottom: 1.5rem;">
    Visualize waste generation patterns over time. Use the aggregation filter in the customize button to switch between daily, weekly, or monthly views.
  </p>

  <!-- Trend Charts Container -->
  <div id="trend-charts-wrapper">
    <!-- Total Waste Trend with Regression -->
    <div class="trend-chart-box" data-section="trends-wastegen">
      <h3 style="color: #2d613f; font-size: 1.1rem; margin-bottom: 0.75rem;">
        <i class="fa-solid fa-trash"></i> Total Waste Generation Trend with Projection
      </h3>
      <canvas id="trendTotalWaste" style="max-height: 300px;"></canvas>
      <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 6px; font-size: 0.9rem;">
        <strong style="color: #2d613f;">ðŸ“Š Trend Analysis:</strong>
        <span id="regressionStats" style="color: #555;"></span>
      </div>
    </div>

    <!-- Per Capita Trend -->
    <div class="trend-chart-box" data-section="trends-percapita">
      <h3 style="color: #2d613f; font-size: 1.1rem; margin-bottom: 0.75rem;">
        <i class="fa-solid fa-user"></i> Per Capita Waste Trend
      </h3>
      <canvas id="trendPerCapita" style="max-height: 300px;"></canvas>
    </div>

    <!-- Waste by Category Trend -->
    <div class="trend-chart-box" data-section="trends-category">
      <h3 style="color: #2d613f; font-size: 1.1rem; margin-bottom: 0.75rem;">
        <i class="fa-solid fa-layer-group"></i> Waste by Category Over Time
      </h3>
      <canvas id="trendByCategory" style="max-height: 350px;"></canvas>
    </div>

    <!-- Compliance Trend -->
    <div class="trend-chart-box" data-section="trends-compliance">
      <h3 style="color: #2d613f; font-size: 1.1rem; margin-bottom: 0.75rem;">
        <i class="fa-solid fa-check-double"></i> Compliance Rate Trend
      </h3>
      <canvas id="trendCompliance" style="max-height: 300px;"></canvas>
    </div>
  </div>
</div>

<div class="simulation-container">
  <h2>Waste Forecast & Simulation Models</h2>

  <div class="model-controls">
    <label for="modelType">Select Model:</label>
    <select id="modelType" onchange="updateSimulationModel()">
      <option value="polynomial">Polynomial Regression</option>
      <option value="arima">ARIMA Forecast</option>
      <option value="system">System Dynamics</option>
    </select>

    <label for="forecastMonths">Months to Forecast:</label>
    <input type="number" id="forecastMonths" min="1" max="24" value="6">

    <button onclick="runSimulation()">Run Simulation</button>
  </div>

  <canvas id="simulationChart" style="max-width: 900px; margin-top: 25px;"></canvas>

  <div id="simulationSummary" class="summary-box"></div>
</div>

<div style="display: flex;">
    <!-- Compliance -->
    <div class="form-section" style="background-color: rgb(227, 255, 227); margin: 0 10px 10px 0 !important; width: 100%;" data-section="compliance-category">
      <h2>Waste Category Compliance Status</h2>

      <!-- Insights -->
      {{{wasteComplianceNarrative}}}

      <table class="compliance-table">
        <tr>
          <th>Waste Category</th>
          <th>Collected</th>
          <th>Total Generated</th>
          <th>Diversion %</th>
          <th>Target %</th>
          <th>Status</th>
        </tr>
        {{#each wasteCompliances}}
          <tr>
            <td>{{supertype_name}}</td>
            <td>{{formatNumber total_collected_weight}} kg</td>
            <td>{{formatNumber total_generated}} kg</td>
            <td>{{diversion_percentage}}%</td>
            <td>{{target_percentage}}%</td>
            <td class="{{#if (eq compliance_status 'Non-Compliant')}}non-compliant{{/if}}">{{compliance_status}}</td>
          </tr>
        {{/each}}
      </table>
    </div>

    <div class="form-section" style="background-color: rgb(227, 255, 227); margin: 0 10px 10px 0 !important; width: 100%;" data-section="compliance-sector">
      <h2>Waste Sector Compliance Status</h2>
      
      <!-- Insights -->
      {{{sectorComplianceNarrative}}}

      <table class="compliance-table">
        <tr>
          <th>Sector Category</th>
          <th>Collected</th>
          <th>Total Generated</th>
          <th>Diversion %</th>
          <th>Target %</th>
          <th>Status</th>
        </tr>
        {{#each sectorCompliances}}
          <tr>
            <td>{{sector_name}}</td>
            <td>{{formatNumber total_collected_weight}} kg</td>
            <td>{{formatNumber total_generated}} kg</td>
            <td>{{diversion_percentage}}%</td>
            <td>{{target_percentage}}%</td>
            <td class="{{#if (eq compliance_status 'Non-Compliant')}}non-compliant{{/if}}">{{compliance_status}}</td>
          </tr>
        {{/each}}
      </table>
    </div>
  </div>

<!-- Insight -->
<hr>
<div data-section="insights" class="form-section" style="background-color: #eef8f2; padding: 1.5rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-top: 2rem;">
  <h2 style="color: #2d613f;"><i class="fa-solid fa-lightbulb" style="margin-right: 8px;"></i>General Waste Category Insights & Recommendations</h2>
  <ul style="font-size: 1.1rem; list-style-type: none; padding-left: 0;">
    {{#each recommendations}}
      <li style="margin-bottom: 1rem;">{{{this}}}</li>
    {{/each}}
  </ul>
</div>

<!-- Data Tabs -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Chart')" id="defaultOpen">CHART</button>
</div>

<!-- Display A: Chart -->
<div id="Chart" class="tabcontent">
    <!-- Supertype summary pie chart -->
    <div data-section="top-categories" style="display: flex;">
        <div class="pie-chart">
            <canvas id="supertypePieChart">
                <!-- Populated by JS -->
            </canvas>
        </div>

        <div id="summary-legend">
            <h2>Top Waste Categories in This Area</h2>
            <p style="font-size: large;" id="summary-description">This pie chart shows the distribution of waste by supertype. Each slice represents the total weight (in kilograms) of waste classified as Biodegradable, Recyclable, Residual, or Special/Hazardous. Hover over a slice to view its percentage and absolute weight.</p>

            {{#each legendData}}
                {{#if (gt value 0)}}
                <span class="legend-item" style="background-color: {{color}}">
                    <span class="legend-name">
                        {{label}}
                        <span class="legend-perc">{{calcPercent value ../legendData}}%</span>
                    </span>
                    <span class="legend-kg">
                        {{toFixed value 3}} kg
                    </span>
                </span>
                {{/if}}
            {{/each}}

            <!-- Toggle showing summary or detailed pie -->
            <button id="togglePieBtn"><i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart</button>
        </div>
    </div><br>

    <!-- Subtypes bar charts -->
    <hr>
    <br><center data-section="top-cats">
        <h2>Top Waste Types by Category</h2>
        <p style="font-size: large;">Each bar chart below focuses on one waste category. The bars represent different types under that category, showing how much each contributed to the total weight.</p>
    </center>
    <div class="bar-tab">
        <button class="bar-tablinks" onclick="openBarTab(event, 'Biodegradable')" id="firstBar">BIODEGRADABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Recyclable')">RECYCLABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Residual')">RESIDUAL</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Special/Hazardous')">SPECIAL/HAZARDOUS</button>
    </div>

    <div id="bar-charts-container"></div>

    <!-- Top sectors producing waste -->
    <br><hr><br>
    <div data-section="top-sectors">
      <center>
        <h2>Top Sectors by Waste Output</h2>
        <p style="font-size: large;">This chart shows which economic sectors contribute the most to total waste generation. Use this insight to target waste reduction initiatives by sector.</p>
      </center>
      <div id="sector-chart-container"></div>
    </div>

    <!-- Pie chart per sector -->
    <br><hr><br>
    <center data-section="cats-per-sector">
      <h2>Top Waste Categories per Sector</h2>
      <p style="font-size: large;">Each pie chart below shows the waste composition for a specific economic sector.</p>
    </center>

    <div class="sector-tab">
        <button class="sector-tablinks" onclick="openPieTab(event, 'Residential')" id="firstSector">RESIDENTIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Commercial')">COMMERCIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Institutional')">INSTITUTIONAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Industrial')">INDUSTRIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Health')">HEALTH</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'AgricultureandLivestock')">AGRICULTURE AND LIVESTOCK</button>
    </div>

    <div id="sector-pies-container"></div>
</div>

<!-- Access to chart.js - MUST BE LOADED BEFORE CHART SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet.js (for map view) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Modal Script -->
<script>

const reportModal = document.getElementById('reportModal');
const btn = document.getElementById('customizeReportBtn');
const closeBtn = document.querySelector('.close');
const cancelBtn = document.getElementById('cancelBtn');
const resetBtn = document.getElementById('resetBtn');
const applyBtn = document.getElementById('applyBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');

btn.onclick = () => reportModal.style.display = 'block';
closeBtn.onclick = () => reportModal.style.display = 'none';
cancelBtn.onclick = () => reportModal.style.display = 'none';
window.onclick = (e) => {
    if (e.target == reportModal) reportModal.style.display = 'none';
}

resetBtn.onclick = () => {
    document.getElementById('modal-wasteType').value = '';
    document.getElementById('modal-sector').value = '';
    document.getElementById('modal-compliance').value = '';
    document.getElementById('modal-aggregation').value = 'daily';
    document.querySelectorAll('input[name="section"]').forEach(cb => cb.checked = true);
}

exportPdfBtn.onclick = () => {
    reportModal.style.display = 'none';
    window.print();
}

applyBtn.onclick = () => {
    const wasteType = document.getElementById('modal-wasteType').value;
    const sector = document.getElementById('modal-sector').value;
    const compliance = document.getElementById('modal-compliance').value;
    const aggregation = document.getElementById('modal-aggregation').value;
    
    const selectedSections = Array.from(document.querySelectorAll('input[name="section"]:checked'))
        .map(cb => cb.value);
    
    document.querySelectorAll('[data-section]').forEach(el => {
        if (el.getAttribute('data-section') !== 'filters' && el.getAttribute('data-section') !== 'data-title') {
            el.style.display = 'none';
        }
    });
    
    selectedSections.forEach(section => {
        const elements = document.querySelectorAll(`[data-section="${section}"]`);
        elements.forEach(el => el.style.display = '');
    });
    
    const currentUrl = new URL(window.location.href);
    
    if (wasteType) currentUrl.searchParams.set('wasteType', wasteType);
    else currentUrl.searchParams.delete('wasteType');
    
    if (sector) currentUrl.searchParams.set('sector', sector);
    else currentUrl.searchParams.delete('sector');
    
    if (compliance) currentUrl.searchParams.set('compliance', compliance);
    else currentUrl.searchParams.delete('compliance');
    
    if (aggregation) currentUrl.searchParams.set('aggregation', aggregation);
    else currentUrl.searchParams.delete('aggregation');
    
    reportModal.style.display = 'none';
    
    if (wasteType || sector || compliance || aggregation) {
        window.location.href = currentUrl.toString();
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>

<script>
let chartInstance;

async function runSimulation() {
  const modelType = document.getElementById("modelType").value;
  const forecastMonths = parseInt(document.getElementById("forecastMonths").value, 10) || 12;

  try {
    // Fetch server-side hybrid simulation (returns simResult & original timeseries)
    const resp = await fetch(`/api/simulation?forecastMonths=${forecastMonths}`);
    const payload = await resp.json();
    if (!payload.success) throw new Error('Simulation endpoint error');

    const simResult = payload.simResult; // [{step,mean,upper,lower}, ...]
    const ts = payload.timeSeriesData || [];

    // Build labels: either real month labels from DB or default Month 1..N
    const labels = simResult.map(s => {
      // if timeSeriesData has date strings, you can map accordingly.
      // Here we keep generic labels as "t+1"
      return `t+${s.step + 1}`;
    });

    // Arrays for plotting
    const meanSeries = simResult.map(s => Number(s.mean));
    const upperSeries = simResult.map(s => Number(s.upper));
    const lowerSeries = simResult.map(s => Number(s.lower));

    // Generate client-side local forecast *aligned to the same horizon*
    // We need to provide the historical portion (if any) then forecast up to horizon
    // Determine historical values (use monthly totals from timeSeriesData if available)
    let historical = [];
    if (Array.isArray(ts) && ts.length > 0) {
      // prefer total_weight if monthly aggregated
      historical = ts.map(r => Number(r.total_weight));
    } else {
      // fallback: use the first N values of sim mean as proxy
      historical = meanSeries.slice(0, Math.max(1, Math.min(6, meanSeries.length)));
    }

    const clientForecast = generateLocalForecast(historical, modelType, forecastMonths, simResult.length);

    // Render chart with server sim mean+bounds and local forecast overlay
    renderChart(labels, meanSeries, upperSeries, lowerSeries, historical, clientForecast, modelType);

    // Update summary
    updateSummary(meanSeries, clientForecast.predictedY, modelType);

  } catch (err) {
    console.error('Run Simulation error:', err);
    alert('Simulation failed: ' + (err.message || 'unknown error'));
  }
}

/* Local forecasts â€” ensure they return arrays matching server horizon length */
function generateLocalForecast(history, modelType, forecastMonths, totalHorizon) {
  if (modelType === 'polynomial') return runPolynomialForecast(history, forecastMonths, totalHorizon);
  if (modelType === 'arima') return runSimpleARIMA(history, forecastMonths, totalHorizon);
  if (modelType === 'system') return runSystemDynamics(history, forecastMonths, totalHorizon);
  return { predictedX: [], predictedY: [] };
}

function runPolynomialForecast(history, forecastMonths, totalHorizon) {
  // Fit to history (x = 1..n), then predict to totalHorizon
  const points = history.map((y, i) => [i + 1, y]);
  const result = regression.polynomial(points, { order: 2 });
  const predictedY = [];
  for (let i = 1; i <= totalHorizon; i++) {
    predictedY.push(result.predict(i)[1]);
  }
  return { predictedX: Array.from({length: totalHorizon}, (_,i) => i+1), predictedY, model: result };
}

function runSimpleARIMA(history, forecastMonths, totalHorizon) {
  // Very simple drift model: extend by mean delta
  const series = history.slice();
  const diffs = series.slice(1).map((v,i) => v - series[i]);
  const avgDiff = diffs.length ? (diffs.reduce((a,b) => a+b,0)/diffs.length) : 0;
  while (series.length < totalHorizon) {
    const next = series[series.length - 1] + avgDiff;
    series.push(next);
  }
  return { predictedX: Array.from({length: totalHorizon}, (_,i)=>i+1), predictedY: series };
}

function runSystemDynamics(history, forecastMonths, totalHorizon) {
  const series = history.slice();
  const disposalRate = 0.6;
  const growthRate = 0.05;
  while (series.length < totalHorizon) {
    const last = series[series.length - 1];
    const newWaste = last * (1 + growthRate);
    const afterDisposal = newWaste * (1 - disposalRate);
    series.push(last + afterDisposal);
  }
  return { predictedX: Array.from({length: totalHorizon}, (_,i)=>i+1), predictedY: series };
}

/* Chart renderer that overlays everything */
function renderChart(labels, meanSeries, upperSeries, lowerSeries, historical, clientForecast, modelType) {
  const ctx = document.getElementById("simulationChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  const datasets = [
    {
      label: "Server sim mean (Monte Carlo)",
      data: meanSeries,
      borderColor: "#1976d2",
      backgroundColor: "rgba(25,118,210,0.08)",
      tension: 0.2,
      fill: false,
      pointRadius: 2
    },
    {
      label: "95% Upper",
      data: upperSeries,
      borderColor: "#ff9800",
      borderDash: [6,4],
      fill: false,
      pointRadius: 0
    },
    {
      label: "95% Lower",
      data: lowerSeries,
      borderColor: "#ff9800",
      borderDash: [6,4],
      fill: '-1', // fill between lower/upper if supported
      pointRadius: 0
    },
    {
      label: `${modelType.toUpperCase()} (Local forecast)`,
      data: clientForecast.predictedY,
      borderColor: "#2e7d32",
      borderDash: [3,3],
      fill: false,
      tension: 0.25
    }
  ];

  chartInstance = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        tooltip: { mode: 'index', intersect: false },
        title: { display: true, text: `Waste Simulation (${modelType.toUpperCase()})` }
      },
      interaction: { mode: 'nearest', axis: 'x', intersect: false },
      scales: {
        x: { title: { display: true, text: 'Time step (monthly index)' } },
        y: { title: { display: true, text: 'Waste (kg)' }, beginAtZero: false }
      }
    }
  });
}

/* summary */
function updateSummary(meanSeries, forecasted, modelType) {
  const summary = document.getElementById("simulationSummary");
  const lastMean = meanSeries[meanSeries.length - 1];
  const lastForecast = forecasted[forecasted.length - 1];
  const pct = lastMean ? (((lastForecast - lastMean) / lastMean) * 100).toFixed(2) : '0.00';
  summary.innerHTML = `
    <h3>Simulation Summary</h3>
    <p><b>Model:</b> ${modelType.toUpperCase()}</p>
    <p><b>Final Mean (server MC):</b> ${Number(lastMean).toLocaleString()} kg</p>
    <p><b>Final Local Forecast:</b> ${Number(lastForecast).toLocaleString()} kg</p>
    <p><b>Change:</b> ${pct}%</p>
  `;
}
</script>




<!-- Trend Charts Script -->
<script>

function getISOWeekNumber(date) {
  const tmp = new Date(date);
  tmp.setHours(0, 0, 0, 0);
  // Thursday in current week decides the year
  tmp.setDate(tmp.getDate() + 3 - ((tmp.getDay() + 6) % 7));
  const week1 = new Date(tmp.getFullYear(), 0, 4);
  const weekNumber = 1 + Math.round(((tmp - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
  return { week: weekNumber, year: tmp.getFullYear() };
}

function parseFlexibleDate(input) {
  if (!input) return null;

  // Convert numbers to string first
  const str = String(input).trim();

  // Case 1: already a Date object
  if (input instanceof Date) return input;

  // Case 2: string with dashes (e.g. "2024-01-02")
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
    return new Date(str);
  }

  // Case 3: YYYYMM or YYYYMMDD compact formats
  if (/^\d{6}$/.test(str)) {
    const year = parseInt(str.slice(0, 4), 10);
    const month = parseInt(str.slice(4, 6), 10) - 1;
    return new Date(year, month, 1);
  }

  if (/^\d{8}$/.test(str)) {
    const year = parseInt(str.slice(0, 4), 10);
    const month = parseInt(str.slice(4, 6), 10) - 1;
    const day = parseInt(str.slice(6, 8), 10);
    return new Date(year, month, day);
  }

  // Case 4: fallback
  const parsed = new Date(str);
  return isNaN(parsed) ? null : parsed;
}

window.addEventListener('DOMContentLoaded', function () {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is not loaded!');
    document.getElementById('trend-charts-wrapper').innerHTML = 
      '<div style="padding: 2rem; text-align: center; color: #f44336;">' +
      '<i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>' +
      '<p style="font-size: 1.1rem;">Chart.js library failed to load. Please refresh the page.</p>' +
      '</div>';
    return;
  }

  const STATIC_SAMPLE_DATA = [
    { date: '2024-01-01', total_weight: 1250, avg_per_capita: 0.45, waste_type: 'Biodegradable', compliance_status: 'Compliant' },
    { date: '2024-01-02', total_weight: 1320, avg_per_capita: 0.48, waste_type: 'Biodegradable', compliance_status: 'Compliant' },
    { date: '2024-01-03', total_weight: 1180, avg_per_capita: 0.42, waste_type: 'Recyclable', compliance_status: 'Non-Compliant' },
    { date: '2024-01-04', total_weight: 1400, avg_per_capita: 0.51, waste_type: 'Biodegradable', compliance_status: 'Compliant' }
  ];
  const timeSeriesData = {{{timeSeriesData}}};

  const dataToUse = (timeSeriesData && timeSeriesData.length > 0) ? timeSeriesData : STATIC_SAMPLE_DATA;

  if (!dataToUse || dataToUse.length === 0) {
    console.warn('No data available for charts');
    document.getElementById('trend-charts-wrapper').innerHTML = 
      '<div style="padding: 2rem; text-align: center; color: #999;">' +
      '<i class="fa-solid fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>' +
      '<p style="font-size: 1.1rem;">No time-series data available. Apply filters and select an aggregation period to view trends.</p>' +
      '</div>';
    return;
  }

  const aggregation = '{{query.aggregation}}' || 'daily';
  const formatDate = (item, aggregation) => {
    if (aggregation === 'daily') {
      return new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    if (aggregation === 'weekly') {
      return `Week ${item.week}, ${item.year}`;
    }
    if (aggregation === 'monthly') {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${months[item.month - 1]} ${item.year}`;
    }
    return item.date || `${item.year}-${item.month || item.week}`;
  };

  // Preprocess data to add week, month, year if missing
  dataToUse.forEach(item => {
    const dateObj = parseFlexibleDate(item.date);
    if (isNaN(dateObj)) return;

    const { week, year } = getISOWeekNumber(dateObj);
    item.year = item.year || year;
    item.month = item.month || dateObj.getMonth() + 1;
    item.week = item.week || week;
  });

  console.log(dataToUse)

  const timePeriods = [...new Set(dataToUse.map(d => formatDate(d, aggregation)))];

  const calculateRegression = (xValues, yValues) => {
    const n = xValues.length;
    const sumX = xValues.reduce((a, b) => a + b, 0);
    const sumY = yValues.reduce((a, b) => a + b, 0);
    const sumXY = xValues.reduce((sum, x, i) => sum + x * yValues[i], 0);
    const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    const yMean = sumY / n;
    const ssTotal = yValues.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
    const ssResidual = yValues.reduce((sum, y, i) => {
      const predicted = slope * xValues[i] + intercept;
      return sum + Math.pow(y - predicted, 2);
    }, 0);
    const rSquared = 1 - (ssResidual / ssTotal);

    return { slope, intercept, rSquared };
  };

  const totalWasteByPeriod = timePeriods.map(period => {
    return dataToUse
      .filter(d => formatDate(d, aggregation) === period)
      .reduce((sum, d) => sum + (parseFloat(d.total_weight) || 0), 0);
  });

  const xValues = Array.from({ length: totalWasteByPeriod.length }, (_, i) => i);
  const regression = calculateRegression(xValues, totalWasteByPeriod);

  const regressionLine = xValues.map(x => regression.slope * x + regression.intercept);
  const futureX = [xValues.length, xValues.length + 1, xValues.length + 2];
  const futureY = futureX.map(x => regression.slope * x + regression.intercept);
  const futureLabels = ['Projection +1', 'Projection +2', 'Projection +3'];

  document.getElementById('regressionStats').innerHTML =
    `${regression.slope > 0 ? 'ðŸ“ˆ Increasing' : 'ðŸ“‰ Decreasing'} at ${Math.abs(regression.slope).toFixed(2)} kg per period | RÂ² = ${(regression.rSquared * 100).toFixed(1)}% | Projected in 3 periods: ${futureY[2].toFixed(2)} kg`;

  new Chart(document.getElementById('trendTotalWaste').getContext('2d'), {
    type: 'line',
    data: {
      labels: [...timePeriods, ...futureLabels],
      datasets: [
        {
          label: 'Actual Waste (kg)',
          data: [...totalWasteByPeriod, null, null, null],
          borderColor: '#4CAF50',
          backgroundColor: 'rgba(76, 175, 80, 0.1)',
          fill: true,
          tension: 0.4
        },
        {
          label: 'Trend Line',
          data: [...regressionLine, ...futureY],
          borderColor: '#FF5722',
          borderDash: [5, 5],
          fill: false
        },
        {
          label: 'Projected Waste',
          data: [...Array(totalWasteByPeriod.length).fill(null), ...futureY],
          borderColor: '#FFC107',
          borderDash: [10, 5]
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: (context) => `${context.dataset.label}: ${context.parsed.y ? context.parsed.y.toFixed(2) : 'N/A'} kg`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Weight (kg)' } },
        x: { title: { display: true, text: 'Time Period' } }
      }
    }
  });

  const perCapitaByPeriod = timePeriods.map(period => {
    const periodData = dataToUse.filter(d => formatDate(d, aggregation) === period);
    const total = periodData.reduce((sum, d) => sum + (parseFloat(d.avg_per_capita) || 0), 0);
    return periodData.length ? total / periodData.length : 0;
  });

  new Chart(document.getElementById('trendPerCapita').getContext('2d'), {
    type: 'line',
    data: {
      labels: timePeriods,
      datasets: [{
        label: 'Per Capita Waste (kg/cap-day)',
        data: perCapitaByPeriod,
        borderColor: '#FF9800',
        backgroundColor: 'rgba(255, 152, 0, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: (context) => `${context.parsed.y.toFixed(4)} kg/cap-day`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'kg/cap-day' }
        }
      }
    }
  });

  const categories = ['Biodegradable', 'Recyclable', 'Residual', 'Special/Hazardous'];
  const categoryColors = {
    'Biodegradable': 'rgba(76, 175, 80, 0.8)',
    'Recyclable': 'rgba(33, 150, 243, 0.8)',
    'Residual': 'rgba(158, 158, 158, 0.8)',
    'Special/Hazardous': 'rgba(244, 67, 54, 0.8)'
  };

  const categoryDatasets = categories.map(cat => ({
    label: cat,
    data: timePeriods.map(period => dataToUse
      .filter(d => formatDate(d, aggregation) === period && d.waste_type === cat)
      .reduce((sum, d) => sum + (parseFloat(d.total_weight) || 0), 0)
    ),
    backgroundColor: categoryColors[cat],
    borderColor: categoryColors[cat].replace('0.8', '1'),
    borderWidth: 2,
    fill: true,
    tension: 0.4
  }));

  new Chart(document.getElementById('trendByCategory').getContext('2d'), {
    type: 'line',
    data: { labels: timePeriods, datasets: categoryDatasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'top' } },
      scales: {
        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Weight (kg)' } },
        x: { stacked: true }
      }
    }
  });

  const complianceByPeriod = timePeriods.map(period => {
    const periodData = dataToUse.filter(d => formatDate(d, aggregation) === period);
    const compliant = periodData.filter(d => d.compliance_status === 'Compliant').length;
    return periodData.length ? (compliant / periodData.length) * 100 : 0;
  });

  new Chart(document.getElementById('trendCompliance').getContext('2d'), {
    type: 'line',
    data: {
      labels: timePeriods,
      datasets: [{
        label: 'Compliance Rate (%)',
        data: complianceByPeriod,
        borderColor: '#2196F3',
        backgroundColor: 'rgba(33, 150, 243, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Compliance Rate (%)' } }
      }
    }
  });
});
</script>

<!-- Pie chart script -->
<script>

const summaryData = {{{summaryPieData}}},
      detailedData = {{{detailedPieData}}},
      barChartData = {{{barChartData}}},
      sectorBarData = {{{sectorBarData}}},
      sectorPieData = {{{sectorPieData}}};

const supertypeDemo = {{{supertypeDemo}}};
const grandTotal = {{{grandTotal}}};

const rand = arr => arr[Math.floor(Math.random() * arr.length)];
const pct = (value, total) => total ? (value / total * 100) : 0;
const fmtKg = (n) => `${Number(n).toFixed(3)} kg`;

const overallPhrases = {
  balanced: [
    "All major categories are nearly proportional, indicating a balanced waste composition with no single dominant source."
  ],
  dominant: [
    "One category dominates the waste stream. Prioritize source reduction and targeted segregation for this category."
  ],
  lowReported: [
    "Some categories show very low or missing volumes. This may be caused by underreporting, misclassification, gaps in reporting, or genuinely low output."
  ],
  mixedDominant: [
    "Several categories contribute significant amounts. Consider combined campaigns (e.g., recycling + organics) rather than programs for a single type."
  ]
};

function generateOverallInsight(supertypeMapObj, grandTotalVal) {
  const supertypes = Object.values(supertypeMapObj);
  const nonzero = supertypes.filter(s => Number(s.totalWeight) > 0);
  const shares = supertypes.map(s => ({
    name: s.name,
    value: Number(s.totalWeight),
    pct: pct(Number(s.totalWeight), grandTotalVal)
  }));
  shares.sort((a,b)=>b.pct-a.pct);

  if (grandTotalVal === 0) {
    return "No waste data recorded for this entry. Please verify and recheck data submissions.";
  }

  const top = shares[0];
  const second = shares[1] || null;
  const avgPct = shares.reduce((a,b)=>a+b.pct,0)/shares.length;
  const deviations = shares.map(s => Math.abs(s.pct - avgPct));
  const allBalanced = deviations.every(d => d < 5);

  const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
  const tinyList = shares.filter(s => s.pct < 10).map(s => s.name);

  if (allBalanced && nonzero.length > 2) {
    let text = overallPhrases.balanced;
    if (lowList.length) text += ` However, some categories appear minimal: ${lowList.join(', ')}.`;
    if (tinyList.length === 1) text += ` The category ${tinyList[0]} is noticeably small compared to others.`;
    return text;
  }

  if (top.pct >= 50) {
    let text = `${overallPhrases.dominant} Currently, <strong>${top.name}</strong> represents ${top.pct.toFixed(1)}% of the total.`;
    if (lowList.length) text += ` Some low categories: ${lowList.join(', ')}.`;
    if (tinyList.length === 1) text += ` ${tinyList[0]} appears significantly underrepresented.`;
    return text;
  }

  const strongList = shares.filter(s => s.pct >= 20);
  if (strongList.length >= 2 && strongList.length < shares.length) {
    let text = `${overallPhrases.mixedDominant} <br><b>Major categories: ${strongList.map(s => s.name).join(', ')}</b>`;
    if (lowList.length) text += ` Lower: ${lowList.join(', ')}.`;
    if (tinyList.length === 1) text += ` The category ${tinyList[0]} has a notably small portion.`;
    return text;
  }

  if (lowList.length === shares.length) {
    return "All categories show minimal values; likely incomplete or unreported data.";
  }
  if (lowList.length) {
    let text = `${overallPhrases.lowReported} Notably low: ${lowList.join(', ')}.`;
    return text;
  }

  const uniquePattern = new Set(shares.map(s => Math.round(s.pct / 5) * 5)).size === shares.length;
  if (uniquePattern && !allBalanced && top.pct < 50) {
    let text = "Each category has a distinct share, showing a varied waste composition with no single type dominating.";
    if (tinyList.length) text += ` The category ${tinyList.join(', ')} has smaller proportions than others.`;
    return text;
  }

  return "The waste composition shows a mixed pattern without extreme concentrations. Continue tracking for shifts over time.";
}

function generateSupertypeInsight(supertypeObj, grandTotalVal) {
  const types = supertypeObj.types || [];
  const total = Number(supertypeObj.totalWeight) || 0;
  if (!total || !types.length) {
    return `No data recorded for <strong>${supertypeObj.name}</strong>. Verify reporting for this category.`;
  }

  const pct = (v, t) => (t ? (v / t) * 100 : 0);

  const pairs = types.map(t => ({
    name: t.name,
    value: Number(t.weight),
    pct: pct(Number(t.weight), total)
  })).sort((a, b) => b.pct - a.pct);

  const top = pairs[0];
  const second = pairs[1] || null;
  const avgPct = pairs.reduce((a, b) => a + b.pct, 0) / pairs.length;
  const allBalanced = pairs.every(p => Math.abs(p.pct - avgPct) < 5);
  const lowList = pairs.filter(p => p.pct < 2).map(p => p.name);

  if (allBalanced && pairs.length > 2) {
    let text = `Types under <strong>${supertypeObj.name}</strong> are evenly distributed.`;
    if (lowList.length) text += ` Lower types: ${lowList.join(', ')}.`;
    return text;
  }

  if (top.pct >= 50 && pairs.length > 1) {
    let text = `<strong>${top.name}</strong> dominates this category (${top.pct.toFixed(1)}%).`;
    if (lowList.length) text += ` Low types: ${lowList.join(', ')}.`;
    text += ` Other categories follow as: ${pairs.slice(1).map(p => `${p.name} (${p.pct.toFixed(1)}%)`).join(', ')}.`;
    return text;
  }

  if (pairs.length >= 2 && top.pct + second.pct > 50 && top.pct < 50) {
    let text = `Two main types lead in <strong>${supertypeObj.name}</strong>: ${top.name} (${top.pct.toFixed(1)}%) and ${second.name} (${second.pct.toFixed(1)}%).`;
    text += ` Remaining types contribute smaller shares: ${pairs.slice(2).map(p => `${p.name} (${p.pct.toFixed(1)}%)`).join(', ')}.`;
    if (lowList.length) text += ` Lower types: ${lowList.join(', ')}.`;
    return text;
  }

  const highList = pairs.filter(p => p.pct >= 20);
  if (highList.length >= 2 && highList.length < pairs.length) {
    let text = `Several types stand out within <strong>${supertypeObj.name}</strong>: ${highList.map(p => p.name).join(', ')}.`;
    if (lowList.length) text += ` Lower types: ${lowList.join(', ')}.`;
    return text;
  }

  const isGradual = pairs.every((p, i, arr) => !i || arr[i - 1].pct - p.pct < 8);
  if (isGradual && !allBalanced && pairs.length > 3) {
    let text = `A gradual decrease is observed in <strong>${supertypeObj.name}</strong>, where values decline smoothly from ${top.name} (${top.pct.toFixed(1)}%) to ${pairs[pairs.length - 1].name} (${pairs[pairs.length - 1].pct.toFixed(1)}%).`;
    return text;
  }

  const hasSteps = pairs.some((p, i) => i && pairs[i - 1].pct - p.pct >= 10);
  if (hasSteps && !isGradual) {
    let text = `<strong>${supertypeObj.name}</strong> shows a stepped pattern (distinct groups of higher and lower types).`;
    text += ` Major contributors: ${pairs.slice(0, 2).map(p => `${p.name} (${p.pct.toFixed(1)}%)`).join(', ')}; smaller groups follow at much lower percentages.`;
    return text;
  }

  if (lowList.length && lowList.length >= pairs.length - 1) {
    return `Most types under <strong>${supertypeObj.name}</strong> are minimal. This may be caused by low generation or incomplete entries (${lowList.join(', ')}).`;
  }

  return `The <strong>${supertypeObj.name}</strong> category shows varied distribution across its types.`;
}

function generateSectorInsight(sectorName, pieDataForSector, sectorTotalValue, grandTotalVal) {
  const labels = pieDataForSector.labels || [];
  const data = pieDataForSector.data || [];
  const pairs = labels.map((l,i) => ({
    label: l,
    value: data[i],
    pct: pct(data[i], sectorTotalValue)
  }));
  pairs.sort((a,b)=>b.pct-a.pct);

  if (sectorTotalValue === 0) {
    return `${sectorName} has no recorded waste. Please check reporting completeness.`;
  }

  const formatList = arr => {
    if (!arr.length) return '';
    const bolded = arr.map(l => `<b>${l}</b>`);
    if (bolded.length === 1) return bolded[0];
    if (bolded.length === 2) return `${bolded[0]} and ${bolded[1]}`;
    return `${bolded.slice(0, -1).join(', ')}, and ${bolded[bolded.length - 1]}`;
  };

  const avgPct = pairs.reduce((a,b)=>a+b.pct,0)/pairs.length;
  const allBalanced = pairs.every(p => Math.abs(p.pct - avgPct) < 5);
  const top = pairs[0];
  const second = pairs[1] || null;
  const lowList = pairs.filter(p => p.pct < 2).map(p => p.label);
  const tinyList = pairs.filter(p => p.pct < 10).map(p => p.label);

  let insight = '';

  if (allBalanced && pairs.length > 2) {
    insight = `Waste in the ${sectorName} sector is evenly distributed among all categories.`;
    if (lowList.length) insight += ` However, some categories appear minimal: ${formatList(lowList)}.`;
    if (tinyList.length === 1) insight += ` The ${formatList(tinyList)} category is noticeably small compared to others.`;
  }

  else if (top.pct >= 50) {
    insight = `<b>${top.label}</b> dominates waste generation in the ${sectorName} sector (${top.pct.toFixed(1)}%).`;
    if (lowList.length) insight += ` Other categories remain minimal: ${formatList(lowList)}.`;
    if (tinyList.length === 1) insight += ` The category ${formatList(tinyList)} shows an especially small share.`;
  }

  else if (pairs.filter(p => p.pct >= 20).length >= 2 && pairs.filter(p => p.pct >= 20).length < pairs.length) {
    const majors = pairs.filter(p => p.pct >= 20).map(p => p.label);
    insight = `Dominant waste types in the ${sectorName} sector are ${formatList(majors)}, sharing most of the total volume.`;
    if (lowList.length) insight += ` Smaller portions are seen in ${formatList(lowList)}.`;
    if (tinyList.length === 1) insight += ` The category ${formatList(tinyList)} has a noticeably small share.`;
  }

  else if (lowList.length === pairs.length) {
    insight = `All categories in the ${sectorName} sector show minimal proportions. This may indicate incomplete or underreported data.`;
  } else if (lowList.length) {
    insight = `Most waste types in the ${sectorName} sector have relatively low proportions. Notably low: ${formatList(lowList)}.`;
  }

  else {
    const uniquePattern = new Set(pairs.map(p => Math.round(p.pct / 5) * 5)).size === pairs.length;
    if (uniquePattern && !allBalanced && top.pct < 50) {
      insight = `Waste distribution in the ${sectorName} sector varies across all categories with no clear dominant type.`;
      if (tinyList.length) insight += ` The category ${formatList(tinyList)} appears smaller in comparison.`;
    } else {
      insight = `The ${sectorName} sector shows a mixed pattern across categories without clear extremes.`;
      if (tinyList.length) insight += ` ${formatList(tinyList)} remains relatively small.`;
    }
  }

  return insight;
}

function generateSectorOverviewInsight(sectorBarArr, grandTotalVal) {
  const validSectors = (sectorBarArr || []).filter(s => Number(s.value) > 0);
  if (!validSectors.length || grandTotalVal === 0) {
    return "No sector data recorded. Please verify that sector totals were generated correctly.";
  }

  const pct = (v, t) => (t ? (v / t) * 100 : 0);

  const shares = validSectors.map(s => ({
    name: s.label,
    value: Number(s.value),
    pct: pct(Number(s.value), grandTotalVal)
  })).sort((a, b) => b.pct - a.pct);

  const top = shares[0];
  const second = shares[1] || null;
  const topPct = top ? top.pct : 0;
  const lowList = shares.filter(s => s.pct < 2).map(s => s.name);
  const avgPct = shares.reduce((a, b) => a + b.pct, 0) / shares.length;
  const allBalanced = shares.every(s => Math.abs(s.pct - avgPct) < 5);

  if (grandTotalVal === 0) {
    return "No waste totals found. Cannot determine sector distribution.";
  }

  if (allBalanced && shares.length >= 3) {
    return "Waste generation is fairly balanced across sectors; no single area stands out as dominant.";
  }

  if (topPct >= 50) {
    let text = `<strong>${top.name}</strong> is the largest contributor, producing ${top.pct.toFixed(1)}% of all recorded waste.`;
    if (lowList.length) text += ` Sectors with low generation include ${lowList.join(', ')}.`;
    return text;
  }

  if (topPct >= 30 && topPct < 50 && second && Math.abs(top.pct - second.pct) < 10) {
    let text = `Waste generation is shared across multiple sectors, led by <strong>${top.name}</strong> and <strong>${second.name}</strong>.`;
    if (lowList.length) text += ` Some smaller sectors include ${lowList.join(', ')}.`;
    return text;
  }

  const isGradual = shares.every((s, i, arr) => !i || arr[i - 1].pct - s.pct < 8);
  if (isGradual && !allBalanced && shares.length > 3) {
    let text = `A gradual decline in waste generation is observed across sectors, with ${top.name} contributing the most and ${shares[shares.length - 1].name} the least.`;
    if (lowList.length) text += ` Some sectors have minimal values such as ${lowList.join(', ')}.`;
    return text;
  }

  const hasSteps = shares.some((s, i) => i && shares[i - 1].pct - s.pct >= 10);
  if (hasSteps && !isGradual) {
    let text = `Waste generation by sector follows a stepped pattern where certain sectors contribute significantly more than others.`;
    if (lowList.length) text += ` The smallest contributors are ${lowList.join(', ')}.`;
    return text;
  }

  if (lowList.length) {
    return `Some sectors show minimal contribution (below 2%): ${lowList.join(', ')}.`;
  }

  return "Sector contributions appear proportionate. Continue monitoring to identify future trends.";
}

function insertOverallInsight() {
  try {
    const overallText = generateOverallInsight(supertypeDemo || {}, Number(grandTotal || 0));
    const container = document.getElementById('summary-description');

    if (container) {
      let box = container.querySelector('.insight-box.overall');
      if (!box) {
        box = document.createElement('div');
        box.className = 'insight-box overall';
        box.style = 'margin-top:1rem; padding:1rem; border-left:4px solid #2e7d32;background:#f7fff8; border-radius:6px;';
        container.appendChild(box);
      }
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">Quick Recommendation</h3><div>${overallText}</div>`;
    }
  } catch (err) {
    console.error('Overall insight generation failed', err);
  }
}

function insertPerSupertypeInsights() {
  try {
    const superMap = supertypeDemo || {};
    for (const sv of Object.values(superMap)) {
      const id = sv.name.replace(/\s+/g, '');
      const wrapper = document.getElementById(id);

      if (!wrapper) continue;

      let box = wrapper.querySelector('.bar-description');
      if (!box) {
        box = document.createElement('div');
        wrapper.appendChild(box);
      }
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">${sv.name} Category</h3><div>${generateSupertypeInsight(sv, Number(grandTotal || 0))}</div>`;
    }
  } catch (err) { console.error(err); }
}

function insertSectorInsights() {
  try {
    for (const [sectorName, pieData] of Object.entries(sectorPieData || {})) {
      const id = sectorName.replace(/\s+/g, '');
      const wrapper = document.getElementById(id);

      if (!wrapper) continue;
      let box = wrapper.querySelector('.sector-pie-desc');

      if (!box) {
        box = document.createElement('div');
        wrapper.appendChild(box);
      }
      const sectorTotalVal = (sectorBarData || []).find(s=>s.label===sectorName)?.value || 0;
      box.innerHTML = `<h3 style="margin:0 0 0.25rem 0;color:#2d613f">${sectorName} Sector</h3><div>${generateSectorInsight(sectorName, pieData, Number(sectorTotalVal || 0), Number(grandTotal || 0))}</div>`;
    }
  } catch (err) { console.error(err); }
}

function insertSectorOverviewInsight() {
  try {
    const container = document.getElementById('sector-chart-container');
    if (!container) return;

    const insightText = generateSectorOverviewInsight(sectorBarData || [], Number(grandTotal || 0));
    
    let box = container.querySelector('.sector-overview');
    if (!box) {
      box = document.createElement('div');
      box.className = 'sector-overview';
      box.style = 'margin-top:1rem; padding:1rem; border-left:4px solid #2e7d32;background:#f7fff8; border-radius:6px;';
      container.appendChild(box);
    }

    box.innerHTML = `
      <h3 style="margin:0 0 0.25rem 0;color:#2d613f">Sector Overview</h3>
      <div>${insightText}</div>
    `;
  } catch (err) {
    console.error('Sector overview insight generation failed', err);
  }
}

let currentMode = 'summary';
const ctx = document.getElementById('supertypePieChart').getContext('2d');

const baseWidth = 600;
const baseHeight = 600;
const detailedExtraHeight = 250;

const createPieChart = (data, mode) => {
  const canvas = document.getElementById('supertypePieChart');
  canvas.width = baseWidth;
  canvas.height = mode === 'detailed'
    ? baseHeight + detailedExtraHeight
    : baseHeight;

  return new Chart(canvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: data.labels,
      datasets: [{
        data: data.data,
        backgroundColor: data.backgroundColor,
        hoverOffset: 20
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: ({ raw, label, chart }) => {
              const total = chart._metasets[0].total || 1;
              const percent = ((raw / total) * 100).toFixed(3);
              return `${label}: ${Number(raw).toFixed(3)} kg (${percent}%)`;
            }
          }
        },
        legend: {
          display: mode === 'detailed',
          position: 'bottom',
          labels: {
            boxWidth: 20,
            padding: 10
          }
        },
        title: { display: false }
      },
      layout: {
        padding: {
          bottom: mode === 'detailed' ? detailedExtraHeight - 100 : 0
        }
      },
      cutout: 0,
      radius: mode === 'summary' ? '80%' : '100%'
    },
    plugins: [{
      id: 'multiColumnLegend',
      afterUpdate(chart) {
        const chartArea = chart.chartArea;
        const centerX = (chartArea.left + chartArea.right) / 2;
        const centerY = (chartArea.top + chartArea.bottom) / 2 - (mode === 'detailed' ? 60 : 0); 
        chart._metasets.forEach(meta => {
          meta.controller.outerRadius = meta.controller.chart.radius;
          meta.controller.chartArea = chartArea;
          meta.controller.xCenter = centerX;
          meta.controller.yCenter = centerY;
        });

        if (mode !== 'detailed') return;

        const legend = chart.legend;
        if (!legend) return;

        const items = legend.legendItems;
        const mid = Math.ceil(items.length / 2);
        const firstCol = items.slice(0, mid);
        const secondCol = items.slice(mid);

        legend.draw = function() {
          const ctx = chart.ctx;
          const font = Chart.helpers.toFont(legend.options.labels.font);
          ctx.font = font.string;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';

          const lineHeight = font.lineHeight + 6;
          const colSpacing = chart.width / 2.5;
          const startY = chart.chartArea.bottom + 30;

          const drawColumn = (col, x) => {
            col.forEach((item, i) => {
              const y = startY + i * lineHeight;
              ctx.fillStyle = item.fillStyle;
              ctx.fillRect(x, y - 5, 12, 12);
              ctx.fillStyle = item.textColor;
              ctx.fillText(item.text, x + 18, y + 2);
            });
          };

          drawColumn(firstCol, chart.chartArea.left + 20);
          drawColumn(secondCol, chart.chartArea.left + colSpacing);
        };
      }
    }]
  });
};

let chart = createPieChart(summaryData, 'summary');

document.getElementById('togglePieBtn').addEventListener('click', () => {
  chart.destroy();
  currentMode = currentMode === 'summary' ? 'detailed' : 'summary';
  chart = createPieChart(
    currentMode === 'summary' ? summaryData : detailedData,
    currentMode
  );
  togglePieBtn.innerHTML = currentMode === 'summary'
    ? '<i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart'
    : '<i class="fa-solid fa-chart-pie"></i>&nbsp; Back to Summary Pie Chart';
});

const createLegendHTML = (legendData, dataset) => {
  const total = dataset.reduce((a, b) => a + b, 0);
  return legendData
    .filter(item => item.value > 0)
    .map(item => {
      const pct = total ? ((item.value / total) * 100).toFixed(3).replace(/\.0+$/, '') : '0';
      return `<span class="legend-item" style="background-color: ${item.color}">
        <span class="bar-legend-name">
          ${item.label}
          <span class="bar-legend-perc">${pct}%</span>
        </span>
        <span class="bar-legend-kg">
          ${item.value.toFixed(3)} kg
        </span>
      </span>`;
    }).join('');
};

const container = document.getElementById('bar-charts-container');

for (const [supertype, chartData] of Object.entries(barChartData)) {
  const tabDiv = document.createElement('div');
  tabDiv.id = supertype.replace(/\s+/g, '');
  tabDiv.classList.add('bar-tabcontent');
  tabDiv.setAttribute('data-section', `types-${supertype.toLowerCase()}`);

  const canvas = document.createElement('canvas');
  canvas.id = `barChart-${supertype.replace(/\s+/g, '-')}`;
  canvas.style.maxWidth = '700px';
  canvas.style.marginBottom = '20px';

  const wrapper = document.createElement('div');
  wrapper.classList.add('chart-wrapper');
  wrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';

  const legendDiv = document.createElement('div');
  legendDiv.classList.add('bar-legend');
  legendDiv.innerHTML = `<h2 class="bar-legend-title">Top ${supertype} Waste Types</h2>` +
    `<div class='bar-description' style='background-color: #eef8f2; padding: 1rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 1rem; width: fit-content'></div>` + 
    createLegendHTML(chartData.legend, chartData.data);

  wrapper.append(canvas, legendDiv);
  tabDiv.appendChild(wrapper);
  container.appendChild(tabDiv);

  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: `${supertype} Waste Types`,
        data: chartData.data,
        backgroundColor: chartData.legend.map(i => i.color)
      }]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      indexAxis: 'x',
      plugins: {
        tooltip: {
          callbacks: {
            label: ({ parsed }) => `${parsed.y.toFixed(3)} kg`
          }
        },
        title: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Weight (kg)' }
        },
        x: {
          ticks: { autoSkip: false, maxRotation: 45, minRotation: 20 }
        }
      }
    }
  });
}

const tsContainer = document.getElementById('sector-chart-container');

const tsCanvas = document.createElement('canvas');
tsCanvas.id = 'sectorBarChart';
tsCanvas.style.maxWidth = '700px';
tsCanvas.style.marginBottom = '20px';

const tsWrapper = document.createElement('div');
tsWrapper.classList.add('chart-wrapper');
tsWrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';
tsWrapper.appendChild(tsCanvas);
tsContainer.appendChild(tsWrapper);

const sectorLabels = sectorBarData.map(i => i.label),
      sectorValues = sectorBarData.map(i => i.value),
      sectorColors = sectorBarData.map(i => i.color);

new Chart(tsCanvas.getContext('2d'), {
  type: 'bar',
  data: {
    labels: sectorLabels,
    datasets: [{
      label: 'Waste by Sector',
      data: sectorValues,
      backgroundColor: sectorColors
    }]
  },
  options: {
    responsive: true,
    indexAxis: 'y',
    plugins: {
      tooltip: {
        callbacks: {
          label: ({ parsed }) => `${parsed.x.toFixed(3)} kg`
        }
      },
      title: { display: false }
    },
    scales: {
      y: { beginAtZero: true, title: { display: true, text: 'Weight (kg)' } },
      x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 20 } }
    }
  }
});

const tsLegendDiv = document.createElement('div');
tsLegendDiv.classList.add('bar-legend');
tsLegendDiv.innerHTML = `<div class='sector-overview' style='margin-top:1rem; padding:1rem; border-left:4px solid #2e7d32;background:#f7fff8; border-radius:6px; margin-bottom: 1rem'></div>` + createLegendHTML(sectorBarData, sectorValues);
const tsLegendWrapper = document.createElement('div');
tsLegendWrapper.appendChild(tsLegendDiv);
tsWrapper.appendChild(tsLegendWrapper);

const sectorContainer = document.getElementById('sector-pies-container');

for (const [sectorName, pieData] of Object.entries(sectorPieData)) {
  const tabDiv = document.createElement('div');
  tabDiv.id = sectorName.replace(/\s+/g, '');
  tabDiv.classList.add('sector-tabcontent');
  tabDiv.setAttribute('data-section', `top-${sectorName.toLowerCase()}`);

  const canvas = document.createElement('canvas');
  canvas.id = `pieChart-${sectorName.replace(/\s+/g, '-')}`;
  canvas.style.cssText = 'max-width:625px; max-height:600px; margin-bottom:20px; margin-left: 30px';

  const wrapper = document.createElement('div');
  wrapper.classList.add('chart-wrapper');
  wrapper.style.cssText = 'display:flex;gap:24px;align-items:flex-start';

  const legendDiv = document.createElement('div');
  legendDiv.classList.add('bar-legend');
  legendDiv.innerHTML = `
    <h2 class="bar-legend-title">${sectorName} Sector</h2>` +
    `<div class='sector-pie-desc' style='background-color: #eef8f2; padding: 1rem; border-radius: 12px; border-left: 6px solid #4CAF50; margin-bottom: 1rem; width: fit-content'></div>` + 
    createLegendHTML(pieData.labels.map((label, i) => ({
      label,
      value: pieData.data[i],
      color: pieData.backgroundColor[i]
    })), pieData.data);

  wrapper.append(canvas, legendDiv);
  tabDiv.appendChild(wrapper);
  sectorContainer.appendChild(tabDiv);

  new Chart(canvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: pieData.labels,
      datasets: [{
        data: pieData.data,
        backgroundColor: pieData.backgroundColor,
        hoverOffset: 20
      }]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ({ raw }) => {
              const total = pieData.data.reduce((a, b) => a + b, 0);
              const pct = total ? ((raw / total) * 100).toFixed(3).replace(/\.0+$/, '') : '0';
              return `${raw.toFixed(3)} kg (${pct}%)`;
            }
          }
        },
        legend: { position: 'right' },
        title: { display: false }
      }
    }
  });
}

insertOverallInsight();
insertPerSupertypeInsights();
insertSectorInsights();
insertSectorOverviewInsight();

</script>

<!-- Map view script -->
<script>
  const locations = {{{locations}}};

  if (locations.length === 0) {
    alert("No coordinates available for the selected filters.");
  } else {
    const map = L.map('map').setView([locations[0].latitude, locations[0].longitude], 0);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const bounds = [];

    locations.forEach(loc => {
      if (loc.latitude && loc.longitude) {
        const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
        bounds.push([loc.latitude, loc.longitude]);
      }
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, {
        padding: [50, 50]
      });
    }
  }
</script>

<!-- JS behind the tabs -->
<script src="/js/tabs.js"></script>
<script src="/js/tabs-bar.js"></script>
<script src="/js/tabs-sector-pie.js"></script>

<style>

.high-priority {
  color: #127009;
  background-color: #c2f3ce;
  padding: 0.75rem;
  border-left: 4px solid #127009;
  border-radius: 6px;
  display: block;
}

.mid-priority {
  color: #cc7a00;
  background-color: #fff4e0;
  padding: 0.75rem;
  border-left: 4px solid #cc7a00;
  border-radius: 6px;
  display: block;
}

.low-priority {
  color: #b30000;
  background-color: #ffe6e6;
  padding: 0.75rem;
  border-left: 4px solid #b30000;
  border-radius: 6px;
  display: block;
}

.insight-general {
  background-color: #eef8f2;
  padding: 1.5rem;
  border-radius: 12px;
  border-left: 6px solid #4CAF50;
  margin-top: 2rem;
}

.insight-compliance {
  background: white;
  border: 1px solid #b5e0b5;
  border-radius: 10px;
  padding: 16px 20px;
  margin: 14px 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  color: #1e4620;
  font-size: 0.95rem;
}
.insight-compliance h3 {
  color: #2e7d32;
  font-size: 1rem;
  margin-bottom: 8px;
}

.compliance-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 0.95rem;
  background-color: #ffffff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}

.compliance-table th {
  background-color: #c8e6c9;
  color: #1b5e20;
  text-align: left;
  padding: 10px 12px;
  font-weight: 600;
  border-bottom: 2px solid #a5d6a7;
}

.compliance-table td {
  padding: 9px 12px;
  border-bottom: 1px solid #e0f2e0;
  color: #2e4630;
}

.compliance-table tr:nth-child(even) {
  background-color: #f9fff9;
}

.compliance-table tr:hover {
  background-color: #eef9ee;
  transition: background-color 0.15s ease-in-out;
}

.compliance-table td:nth-child(2),
.compliance-table td:nth-child(3),
.compliance-table td:nth-child(4),
.compliance-table td:nth-child(5) {
  text-align: right;
}

.compliance-table td:nth-child(6) {
  text-align: center;
  font-weight: 600;
}

.non-compliant {
  color: #c62828 !important;
}

.filter-columns {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.filter-column {
  flex: 1 1 300px;
  display: flex;
  flex-direction: column;
}

.filter-column label {
  font-weight: 600;
  margin-top: 0.8rem;
  margin-bottom: 0.3rem;
}

.filter-section {
  background: #fafafa;
  border: 1px solid #ccc;
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

.trend-chart-box {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.trend-chart-box h3 {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#trend-charts-wrapper {
  display: grid;
  gap: 1.5rem;
}

.btn-customize {
    background: linear-gradient(135deg, #4CAF50 0%, #2d613f 100%);
    color: white;
    border: none;
    padding: 0.875rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    transition: all 0.3s;
}

.btn-customize:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: #fff;
    margin: 3% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: slideDown 0.3s;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #4CAF50 0%, #2d613f 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
}

.close:hover {
    color: #ffeb3b;
}

.modal-body {
    padding: 2rem;
    max-height: 65vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 2rem;
    background-color: #f8f9fa;
    border-radius: 0 0 12px 12px;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.filter-tag {
    background-color: #e8f5e9;
    color: #2d613f;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    border: 1px solid #4CAF50;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
}

.filter-grid label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2d613f;
}

.filter-grid label i {
    margin-right: 0.5rem;
    color: #4CAF50;
}

.filter-grid select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.filter-grid select:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
}

.checkbox-grid label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.checkbox-grid label:hover {
    background-color: #f5f5f5;
}

.checkbox-grid input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #4CAF50;
}

.checkbox-grid label i {
    color: #4CAF50;
    width: 18px;
}

.btn-primary {
    background: linear-gradient(135deg, #4CAF50 0%, #2d613f 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-secondary:hover {
    background-color: #5a6268;
    transform: translateY(-2px);
}

hr {
    margin: 1.5rem 0;
    border: none;
    border-top: 1px solid #ddd;
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 2% auto;
    }
    
    .filter-grid,
    .checkbox-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-footer {
        flex-direction: column;
    }
    
    .btn-primary,
    .btn-secondary {
        width: 100%;
    }
}

.info-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.info-grid .form-section {
  flex: 1 1 280px;
  min-width: 280px;
}

.user-profile {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
}

.user-profile td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid #eee;
}

.user-profile .label {
  font-weight: 600;
  color: #444;
  width: 50%;
}

.title-card h1 {
  font-size: 1.75rem;
}

.btn-submit {
  background-color: #28a745;
  border: none;
  padding: 0.6rem 1.2rem;
  color: white;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.2s ease;
}

.btn-submit:hover {
  background-color: #218838;
}

.tab-new {
  text-align: center;
  margin-top: 2rem;
}

.tab-new button {
  background-color: #f1f1f1;
  border: none;
  padding: 0.75rem 1.5rem;
  margin: 0 5px;
  cursor: pointer;
  font-weight: 600;
  border-radius: 8px;
  transition: background-color 0.2s;
}

.tab-new button:hover,
.tab-new button.active {
  background-color: #d0e6ff;
}

.form-section {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.form-section h3 {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #2c3e50;
  align-items: center;
}

.form-section h3 i {
  margin-right: 0.6rem;
  color: #127009;
}

.form-section label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-section input[type="text"],
.form-section input[type="date"],
.form-section input[type="number"],
.form-section select {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.3rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.pie-legend {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 12px;
}

.pie-chart {
  width: 625px;
  height: 600px;
  margin-bottom: 20px;
  margin-left: 30px;
}

.legend-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  border-radius: 6px;
  color: white;
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.legend-name {
  display: flex;
  flex-direction: column;
}

.legend-perc {
  font-size: 0.85rem;
  opacity: 0.9;
}

.legend-kg {
  font-weight: 700;
  font-size: 1.05rem;
}

#summary-legend {
  flex: 1;
  padding-left: 20px;
}

#summary-legend h2 {
  color: #2d613f;
  margin-bottom: 0.5rem;
}

#togglePieBtn {
  margin-top: 20px;
  padding: 10px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background-color 0.3s;
}

#togglePieBtn:hover {
  background-color: #45a049;
}

.chart-wrapper {
  display: flex;
  gap: 24px;
  align-items: flex-start;
  margin-bottom: 40px;
}

.bar-legend {
  flex: 1;
  min-width: 250px;
}

.bar-legend-title {
  color: #2d613f;
  margin-bottom: 1rem;
  font-size: 1.2rem;
}

.bar-legend-name {
  display: flex;
  flex-direction: column;
}

.bar-legend-perc {
  font-size: 0.85rem;
  opacity: 0.9;
}

.bar-legend-kg {
  font-weight: 700;
  font-size: 1.05rem;
}

.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
  text-align: center;
  border-radius: 8px 8px 0 0;
  margin-top: 20px;
}

.tab button {
  background-color: inherit;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 17px;
  font-weight: 600;
  color: #333;
}

.tab button:hover {
  background-color: #ddd;
}

.tab button.active {
  background-color: #4CAF50;
  color: white;
}

.tabcontent {
  display: none;
  padding: 20px;
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background-color: white;
}

.bar-tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #e8f5e9;
  text-align: center;
  border-radius: 8px 8px 0 0;
  margin-top: 20px;
}

.bar-tab button {
  background-color: inherit;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 12px 14px;
  transition: 0.3s;
  font-size: 15px;
  font-weight: 600;
  color: #2d613f;
}

.bar-tab button:hover {
  background-color: #c8e6c9;
}

.bar-tab button.active {
  background-color: #4CAF50;
  color: white;
}

.bar-tabcontent {
  display: none;
  padding: 20px;
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background-color: white;
}

.sector-tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #e3f2fd;
  text-align: center;
  border-radius: 8px 8px 0 0;
  margin-top: 20px;
}

.sector-tab button {
  background-color: inherit;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 12px 14px;
  transition: 0.3s;
  font-size: 15px;
  font-weight: 600;
  color: #1565C0;
}

.sector-tab button:hover {
  background-color: #bbdefb;
}

.sector-tab button.active {
  background-color: #2196F3;
  color: white;
}

.sector-tabcontent {
  display: none;
  padding: 20px;
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background-color: white;
}

#map {
  height: 400px;
  border-radius: 8px;
  border: 2px solid #ccc;
}

@media print {
  .modal {
    display: none !important;
  }
  
  .btn-customize {
    display: none !important;
  }
  
  body {
    background: white;
  }
  
  .form-section {
    page-break-inside: avoid;
  }
}
.simulation-container {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin: 2rem auto;
  max-width: 950px;
  color: #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.model-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

button {
  background-color: #28a745;
  border: none;
  color: #fff;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

button:hover {
  background-color: #23963b;
}

.summary-box {
  margin-top: 1rem;
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 10px;
  background-color: #f9fff9;
  font-family: 'Segoe UI', sans-serif;
}

</style>