
<!-- Actual Data Display -->

<!-- Title card -->
<fieldset style="width: 97.3%; margin-bottom: 10px; padding-top: 20px; padding-bottom: 20px">
    <h1 style="margin:0">{{wasteGen.title}}</h1>
    <h3 style="margin:0; font-weight:normal;">
        <i class="fa-solid fa-location-dot"></i>&nbsp; {{wasteGen.location_name}}
    </h3>
</fieldset>

<!-- Data entry info -->
<div style="display: flex;">
    <fieldset style="width: 100%;">
        <legend>Submission Info</legend>
        <table class="user-profile">
            <tr>
                <td class="label">Submitted by</td>
                <td>{{uppercase wasteGen.lastname}}, {{wasteGen.firstname}}</td>
            </tr>
            <tr>
                <td class="label">Organization Name</td>
                <td>{{wasteGen.company_name}}</td>
            </tr>
            <tr>
                <td class="label">Date Submitted</td>
                <td>{{textDate wasteGen.date_submitted}}</td>
            </tr>
        </table>
    </fieldset>

    <fieldset style="width: 100%;">
        <legend>Collection Info</legend>
        <table class="user-profile">
            <tr>
                <td class="label">Start Date</td>
                <td>{{textDate wasteGen.collection_start}}</td>
            </tr>
            <tr>
                <td class="label">End Date</td>
                <td>{{textDate wasteGen.collection_end}}</td>
            </tr>
        </table>
    </fieldset>

    <fieldset style="width: 95%;">
            <legend>Waste Generation</legend>
            <table class="user-profile">
                <tr>
                    <td class="label">Population (based on Census)</td>
                    <td>{{commaNumber wasteGen.population}}</td>
                </tr>
                <tr>
                    <td class="label">Waste Generation per Capita (Kg/cap-day)</td>
                    <td>{{commaNumber wasteGen.per_capita}}</td>
                </tr>
                <tr>
                    <td class="label">Annual Waste Generation (kg/year)</td>
                    <td>{{commaNumber wasteGen.annual}}</td>
                </tr>
            </table>
        </fieldset>
</div>

<!-- Data tabs -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Chart')" id="defaultOpen">CHART</button>
  <button class="tablinks" onclick="openTab(event, 'Table')">RAW DATA</button>
</div>

<!-- Display A: Chart -->
<div id="Chart" class="tabcontent">
    <!-- Supertype summary pie chart -->
    <div class="pie-chart">
        <canvas id="supertypePieChart">
            <!-- Populated by JS -->
        </canvas>

        <!-- Toggle showing summary or detailed pie -->
        <button id="togglePieBtn">More Details</button>
    </div>

    <!-- Subtypes bar charts -->
    <div id="bar-charts-container"></div>
</div>

<!-- Display B: Raw Data -->
<div id="Table" class="tabcontent">
    <div style="display: flex;">
        <div id="data-table-container">
            <div class="table-operations">
                <input type="text" class="tbl-search" placeholder="Enter keyword...">&nbsp;
                <button type="button" class="tbl-export">
                    <i class="fa-solid fa-magnifying-glass"></i>&nbsp; Search
                </button>
                
                <!-- Export buttons -->
                <div style="margin-left: auto;">
                    <button onclick="exportTableToCSV()" class="button tbl-export">
                        <i class="fa-solid fa-file-csv"></i>&nbsp; Export as CSV
                    </button>
                    <button onclick="exportTableToExcel()" class="button tbl-export">
                        <i class="fa-solid fa-file-excel"></i>&nbsp; Export as Excel
                    </button>
                </div>
            </div>

            <!-- Waste Composition -->
            <table class="data-table" id="waste-comp-table">
                <thead>
                    <tr class="tb-header">
                        <th>Waste Type</th>
                        {{#each sectors}}
                            <th style="width: 100px;">{{name}}</th>
                        {{/each}}
                        <th>Total (kg)</th>
                        <th>Percentage (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each supertypes}}
                        <tr>
                            <td colspan="{{add ../sectors.length 3}}" class="tb-supertype"><strong>{{uppercase name}}</strong></td>
                        </tr>
                        {{#each types}}
                            <tr>
                            <td>{{name}}</td>
                            {{#with amounts as |a|}} <!-- Set alias for amounts -->
                                {{#each ../../../sectors}}
                                    <td style="text-align: center;">{{lookup a this.id}}</td>
                                {{/each}}
                                <td style="text-align: center;">{{../totalWeight}}</td>
                                <td style="text-align: center;">{{../percentage}}%</td>
                            {{/with}}
                            </tr>
                        {{/each}}
                        <tr class="tb-subtotal">
                            <td style="text-align: left;"><strong>{{name}} Subtotal</strong></td>
                            {{#each ../sectors}}
                                <td><strong>{{lookup ../this.sectorTotals this.id}}</strong></td>
                            {{/each}}
                            <td><strong>{{this.totalWeight}}</strong></td>
                            <td><strong>{{this.percentage}}%</strong></td>
                        </tr>
                    {{/each}}
                </tbody>
                <tfoot>
                    <tr class="tb-total">
                        <td style="text-align:left">TOTAL</td>
                        {{#each sectors}}
                        <td>{{lookup ../sectorTotals this.id}}</td>
                        {{/each}}
                        <td>{{grandTotal}}</td>
                        <td>100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Footer: Link to edit history -->
<fieldset style="width: 97.3%; margin-bottom: 10px; margin-top: 10px; padding-top: 20px; padding-bottom: 20px">
    This page was last edited on <b>{{latestEdit}}</b><br><br>
    <a href="/dashboard/data/{{wasteGen.data_entry_id}}/history">
        <button class="btn-submit"><i class="fa-solid fa-clock-rotate-left"></i> View Edit History</button>
    </a>
</fieldset>

<!-- Pie chart script -->
<script>

/* --------- PIE CHART --------- */
const summaryData = {{{summaryPieData}}};
const detailedData = {{{detailedPieData}}};

let currentMode = 'summary';
const ctx = document.getElementById('supertypePieChart').getContext('2d');

const createPieChart = (data, title) => {
    return new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: data.backgroundColor,
                hoverOffset: 20
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                callbacks: {
                    label: function (context) {
                        const value = Number(context.raw).toFixed(3);
                        const total = context.chart._metasets[0].total || 1;
                        const percent = ((context.raw / total) * 100).toFixed(3);
                        return `${context.label}: ${value} kg (${percent}%)`;
                    }
                }
                },
                title: {
                    display: true,
                    text: title
                },
                legend: {
                    position: 'right'
                }
            }
        }
    });
};

let chart = createPieChart(summaryData, "Waste by Supertype");

document.getElementById('togglePieBtn').addEventListener('click', () => {
    chart.destroy();
    if (currentMode === 'summary') {
        chart = createPieChart(detailedData, "Detailed Waste by Type");
        currentMode = 'detailed';
        togglePieBtn.textContent = 'Back to Summary';
    } else {
        chart = createPieChart(summaryData, "Waste by Supertype");
        currentMode = 'summary';
        togglePieBtn.textContent = 'More Details';
    }
});

/* --------- BAR CHART --------- */

// Build bar chart
const barChartData = {{{barChartData}}}; // already JSON string

const container = document.getElementById('bar-charts-container');

for (const [supertype, chartData] of Object.entries(barChartData)) {

    // Create canvas for each supertype
    const canvas = document.createElement('canvas');
    canvas.id = `barChart-${supertype.replace(/\s+/g, '-')}`;
    canvas.style.maxWidth = '600px';
    canvas.style.marginBottom = '40px';
    container.appendChild(canvas);

    // Create chart
    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: `${supertype} Waste Types`,
                data: chartData.data,
                backgroundColor: chartData.color
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'x', // vertical
            plugins: {
                title: {
                display: true,
                text: supertype
                },
                tooltip: {
                callbacks: {
                    label: function(context) {
                    return `${context.parsed.y.toFixed(3)} kg`;
                    }
                }
                }
            },
            scales: {
                y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Weight (kg)'
                }
                },
                x: {
                ticks: {
                    autoSkip: false,
                    maxRotation: 45,
                    minRotation: 20
                }
                }
            }
        }
    });
}

</script>

<!-- File export script -->
<script>

const table = document.getElementById("waste-comp-table");

function exportTableToCSV() {
    let csv = [];
    for (let row of table.rows) {
    let rowData = [];
    for (let cell of row.cells) {
        rowData.push(`"${cell.textContent.trim()}"`);
    }
    csv.push(rowData.join(","));
    }
    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "waste-data.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportTableToExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "WasteData");
    XLSX.writeFile(wb, "waste-data.xlsx");
}

</script>

<!-- Access to chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetsJS (for Excel export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- JS behind the tabs -->
<script src="/js/tabs.js"></script>
