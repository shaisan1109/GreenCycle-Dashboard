
<!-- Actual Data Display -->

<!-- Title Card -->
<div class="form-section title-card" style="text-align: center;">
  <h1 style="margin-bottom: 0.25rem;">{{wasteGen.title}}</h1>
  <center>
    <h3 style="margin: 0; font-weight: normal; color: #555;">
        <i class="fa-solid fa-location-dot" style="color: #127009;"></i>&nbsp; {{wasteGen.location_name}}
    </h3>
  </center>
</div>

<!-- Info Blocks -->
<div class="info-grid">
  <!-- Submission Info -->
  <div class="form-section">
    <h3><i class="fas fa-user"></i> Submission Info</h3>
    <table class="user-profile">
      <tr>
        <td class="label">Submitted by</td>
        <td>{{uppercase wasteGen.lastname}}, {{wasteGen.firstname}}</td>
      </tr>
      <tr>
        <td class="label">Organization Name</td>
        <td>{{wasteGen.company_name}}</td>
      </tr>
      <tr>
        <td class="label">Date Submitted</td>
        <td>{{textDate wasteGen.date_submitted}}</td>
      </tr>
    </table>
  </div>

  <!-- Collection Info -->
  <div class="form-section">
    <h3><i class="fas fa-calendar-alt"></i> Collection Info</h3>
    <table class="user-profile">
      <tr>
        <td class="label">Start Date</td>
        <td>{{textDate wasteGen.collection_start}}</td>
      </tr>
      <tr>
        <td class="label">End Date</td>
        <td>{{textDate wasteGen.collection_end}}</td>
      </tr>
    </table>
  </div>

  <!-- Waste Generation Info -->
  <div class="form-section">
    <h3><i class="fas fa-dumpster"></i> Waste Generation</h3>
    <table class="user-profile">
      <tr>
        <td class="label">Population (based on Census)</td>
        <td>{{commaNumber wasteGen.population}}</td>
      </tr>
      <tr>
        <td class="label">Waste Generation per Capita (Kg/cap-day)</td>
        <td>{{commaNumber wasteGen.per_capita}}</td>
      </tr>
      <tr>
        <td class="label">Annual Waste Generation (kg/year)</td>
        <td>{{commaNumber wasteGen.annual}}</td>
      </tr>
    </table>
  </div>
</div>

<!-- Data Tabs -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Chart')" id="defaultOpen">CHART</button>
  <button class="tablinks" onclick="openTab(event, 'Table')">RAW DATA</button>
</div>

<!-- Display A: Chart -->
<div id="Chart" class="tabcontent">
    <!-- Supertype summary pie chart -->
    <div style="display: flex;">
        <div class="pie-chart">
            <canvas id="supertypePieChart">
                <!-- Populated by JS -->
            </canvas>
        </div>

        <div id="summary-legend">
            <h2 style="margin-bottom: 0">Top Waste Categories in This Area</h2>
            <p style="font-size: large;">Mouse over the pie slices to see more details.</p>

            {{#each legendData}}
                {{#if (gt value 0)}}
                <span class="legend-item" style="background-color: {{color}}">
                    <span class="legend-name">
                        {{label}}
                        <span class="legend-perc">{{calcPercent value ../legendData}}%</span>
                    </span>
                    <span class="legend-kg">
                        {{toFixed value 3}} kg
                    </span>
                </span>
                {{/if}}
            {{/each}}

            <!-- Toggle showing summary or detailed pie -->
            <button id="togglePieBtn"><i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart</button>
        </div>
    </div>

    <hr>

    <!-- Summary pie -->
    <br><center><h2>Top Waste Types by Category</h2></center>
    <div class="bar-tab">
        <button class="bar-tablinks" onclick="openBarTab(event, 'Biodegradable')" id="firstBar">BIODEGRADABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Recyclable')">RECYCLABLE</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Residual')">RESIDUAL</button>
        <button class="bar-tablinks" onclick="openBarTab(event, 'Special/Hazardous')">SPECIAL/HAZARDOUS</button>
    </div>

    <!-- Subtypes bar charts -->
    <div id="bar-charts-container"></div>

    <!-- Top sectors producing waste -->
    <br><hr><br>
    <center><h2>Top Sectors by Waste Output</h2></center>
    <div id="sector-chart-container"></div>

    <!-- Pie chart per sector -->
    <br><hr><br>
    <center><h2>Waste Categories per Sector</h2></center>
    <div class="sector-tab">
        <button class="sector-tablinks" onclick="openPieTab(event, 'Residential')" id="firstSector">RESIDENTIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Commercial')">COMMERCIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Institutional')">INSTITUTIONAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Industrial')">INDUSTRIAL</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'Health')">HEALTH</button>
        <button class="sector-tablinks" onclick="openPieTab(event, 'AgricultureandLivestock')">AGRICULTURE AND LIVESTOCK</button>
    </div>

    <div id="sector-pies-container"></div>
</div>

<!-- Display B: Raw Data -->
<div id="Table" class="tabcontent">
    <p style="font-size: large;">This table shows the waste composition for <b>{{wasteGen.location_name}}</b> according to waste type. The waste types are further divided into <b>economic sectors</b> (e.g., Residential, Commercial). All raw amounts are in <b>kilograms (kg)</b>.</p>     

    <div style="display: flex;">
        <div id="data-table-container">
            <div class="table-operations">
                <div style="display: flex;">
                    <!-- Search bar -->
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" class="tbl-search" id="tbl-search" placeholder="Enter keyword...">
                    </div>&nbsp;
                    
                    <!-- Supertype filter -->
                    <select id="supertype-filter">
                        <option value="all">Select Category</option>
                        <option value="Biodegradable">Biodegradable</option>
                        <option value="Recyclable">Recyclable</option>
                        <option value="Residual">Residual</option>
                        <option value="Special/Hazardous">Special/Hazardous</option>
                    </select>
                    
                    <!-- Export buttons -->
                    <div style="margin-left: auto;">
                        <button onclick="exportTableToCSV()" class="button tbl-export">
                            <i class="fa-solid fa-file-csv"></i>&nbsp; Export as CSV
                        </button>
                        <button onclick="exportTableToExcel()" class="button tbl-export">
                            <i class="fa-solid fa-file-excel"></i>&nbsp; Export as Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Waste Composition -->
            <table class="data-table" id="waste-comp-table">
                <thead>
                    <tr class="tb-header">
                        <th>Waste Type</th>
                        {{#each sectors}}
                            <th style="width: 100px;">{{name}}</th>
                        {{/each}}
                        <th>Total (kg)</th>
                        <th>Percentage (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each supertypes}}
                        <tr supertype="{{name}}">
                            <td colspan="{{add ../sectors.length 3}}" class="tb-supertype"><strong>{{uppercase name}}</strong></td>
                        </tr>
                        {{#each types}}
                            <tr supertype="{{../name}}">
                            <td>{{name}}</td>
                            {{#with amounts as |a|}} <!-- Set alias for amounts -->
                                {{#each ../../../sectors}}
                                    <td style="text-align: center;">{{lookup a this.id}}</td>
                                {{/each}}
                                <td style="text-align: center;">{{../totalWeight}}</td>
                                <td style="text-align: center;">{{../percentage}}%</td>
                            {{/with}}
                            </tr>
                        {{/each}}
                        <tr class="tb-subtotal" supertype="{{name}}">
                            <td style="text-align: left;"><strong>{{name}} Subtotal</strong></td>
                            {{#each ../sectors}}
                                <td><strong>{{lookup ../this.sectorTotals this.id}}</strong></td>
                            {{/each}}
                            <td><strong>{{this.totalWeight}}</strong></td>
                            <td><strong>{{this.percentage}}%</strong></td>
                        </tr>
                    {{/each}}
                </tbody>
                <tfoot>
                    <tr class="tb-total">
                        <td style="text-align:left">TOTAL</td>
                        {{#each sectors}}
                        <td>{{lookup ../sectorTotals this.id}}</td>
                        {{/each}}
                        <td>{{grandTotal}}</td>
                        <td>100%</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="form-section" style="text-align: center; margin-top: 1rem;">
  <p>This page was last edited on <b>{{latestEdit}}</b></p>
  <a href="/dashboard/data/{{wasteGen.data_entry_id}}/history">
    <button class="btn-submit">
      <i class="fa-solid fa-clock-rotate-left"></i> View Edit History
    </button>
  </a>
</div>

<!-- Table filtering script -->
<script>

// Supertype filter
const searchInput = document.getElementById('tbl-search');
const dropdown = document.getElementById('supertype-filter');

function filterTable() {
  const keyword = searchInput.value.trim().toLowerCase();
  const selectedSupertype = dropdown.value;
  const allRows = document.querySelectorAll('tr[supertype]');

  allRows.forEach(row => {
    const rowSupertype = row.getAttribute('supertype');
    const text = row.textContent.toLowerCase();
    const matchesSupertype = selectedSupertype === 'all' || rowSupertype === selectedSupertype;
    const matchesSearch = text.includes(keyword);

    row.style.display = matchesSupertype && matchesSearch ? '' : 'none';
  });
}

searchInput.addEventListener('input', filterTable);
dropdown.addEventListener('change', filterTable);

</script>

<!-- Chart script -->
<script>

/* --------- PIE CHART --------- */
const summaryData = {{{summaryPieData}}};
const detailedData = {{{detailedPieData}}};

let currentMode = 'summary';
const ctx = document.getElementById('supertypePieChart').getContext('2d');

const createPieChart = (data) => {
    return new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: data.backgroundColor,
                hoverOffset: 20
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                callbacks: {
                    label: function (context) {
                        const value = Number(context.raw).toFixed(3);
                        const total = context.chart._metasets[0].total || 1;
                        const percent = ((context.raw / total) * 100).toFixed(3);
                        return `${context.label}: ${value} kg (${percent}%)`;
                    }
                }
                },
                title: {
                    display: false
                },
                legend: {
                    position: 'right'
                }
            }
        }
    });
};

let chart = createPieChart(summaryData, "Waste by Supertype");

document.getElementById('togglePieBtn').addEventListener('click', () => {
    chart.destroy();
    if (currentMode === 'summary') {
        chart = createPieChart(detailedData, "Detailed Waste by Type");
        currentMode = 'detailed';
        togglePieBtn.innerHTML = '<i class="fa-solid fa-chart-pie"></i>&nbsp; Back to Summary Pie Chart';
    } else {
        chart = createPieChart(summaryData, "Waste by Supertype");
        currentMode = 'summary';
        togglePieBtn.innerHTML = '<i class="fa-solid fa-circle-info"></i>&nbsp; Show Detailed Pie Chart';
    }
});

/* --------- BAR CHARTS BY WASTE TYPE --------- */

// Build bar chart
const barChartData = {{{barChartData}}};
const container = document.getElementById('bar-charts-container');

for (const [supertype, chartData] of Object.entries(barChartData)) {
    // Create the wrapper tabcontent div
    const tabContentDiv = document.createElement('div');
    tabContentDiv.id = supertype.replace(/\s+/g, '');
    tabContentDiv.classList.add('bar-tabcontent');

    // Create canvas
    const canvas = document.createElement('canvas');
    canvas.id = `barChart-${supertype.replace(/\s+/g, '-')}`;
    canvas.style.maxWidth = '560px';
    canvas.style.marginBottom = '20px';
    tabContentDiv.appendChild(canvas);

    // Create chart wrapper
    const wrapper = document.createElement('div');
    wrapper.classList.add('chart-wrapper');
    wrapper.style.display = 'flex';
    wrapper.style.gap = '24px';
    wrapper.style.alignItems = 'flex-start';
    container.appendChild(wrapper);

    wrapper.appendChild(canvas);

    // Create legend div
    const legendDiv = document.createElement('div');
    legendDiv.classList.add('bar-legend');

    // Create title <h2>
    const legendTitle = document.createElement('h2');
    legendTitle.classList.add('bar-legend-title');
    legendTitle.textContent = `Top ${supertype} Waste Types`;
    legendDiv.appendChild(legendTitle);

    // Generate legend HTML
    legendDiv.innerHTML += chartData.legend
    .filter(item => item.value > 0)
    .map(item => {
        const total = chartData.data.reduce((sum, val) => sum + val, 0);
        const percent = total ? ((item.value / total) * 100).toFixed(3).replace(/\.?0+$/, '') : '0';

        return `<span class="legend-item" style="background-color: ${item.color}">
            <span class="bar-legend-name">
                ${item.label}
                <span class="bar-legend-perc">${percent}%</span>
            </span>
            <span class="bar-legend-kg">
                ${item.value.toFixed(3)} kg
            </span>
        </span>`;
    }).join('');

    // Append title and legend to tab content
    wrapper.appendChild(legendDiv);

    // Append wrapper to tabcontent
    tabContentDiv.appendChild(wrapper);

    // Append everything to main container
    container.appendChild(tabContentDiv);

    // Chart.js setup
    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
            label: `${supertype} Waste Types`,
            data: chartData.data,
            backgroundColor: chartData.legend.map(item => item.color)
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'x',
            plugins: {
            title: {
                display: false
            },
            tooltip: {
                callbacks: {
                label: function(context) {
                    return `${context.parsed.y.toFixed(3)} kg`;
                }
                }
            }
            },
            scales: {
            y: {
                beginAtZero: true,
                title: {
                display: true,
                text: 'Weight (kg)'
                }
            },
            x: {
                ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 20
                }
            }
            }
        }
    });
}

/* --------- SECTOR BAR CHART --------- */

const sectorBarData = {{{sectorBarData}}}; // already a JSON array
const tsContainer = document.getElementById('sector-chart-container');

// Chart canvas
const tsCanvas = document.createElement('canvas');
tsCanvas.id = 'sectorBarChart';
tsCanvas.style.maxWidth = '600px';
tsCanvas.style.marginBottom = '20px';

const tsWrapper = document.createElement('div');
tsWrapper.classList.add('chart-wrapper');
tsWrapper.style.display = 'flex';
tsWrapper.style.gap = '24px';
tsWrapper.style.alignItems = 'flex-start';

tsWrapper.appendChild(tsCanvas);
tsContainer.appendChild(tsWrapper);

// Data prep
const labels = sectorBarData.map(item => item.label);
const values = sectorBarData.map(item => item.value);
const colors = sectorBarData.map(item => item.color);

// Chart.js
new Chart(tsCanvas.getContext('2d'), {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      label: 'Waste by Sector',
      data: values,
      backgroundColor: colors
    }]
  },
  options: {
    responsive: true,
    indexAxis: 'y',
    plugins: {
      title: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: context => `${context.parsed.y.toFixed(3)} kg`
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Weight (kg)'
        }
      },
      x: {
        ticks: {
          autoSkip: false,
          maxRotation: 45,
          minRotation: 20
        }
      }
    }
  }
});

// Create legend title and div
const tsLegendDiv = document.createElement('div');
tsLegendDiv.classList.add('bar-legend');

tsLegendDiv.innerHTML = sectorBarData
  .filter(item => item.value > 0)
  .map(item => {
    const total = values.reduce((sum, v) => sum + v, 0);
    const percent = total ? ((item.value / total) * 100).toFixed(3).replace(/\.?0+$/, '') : '0';
    return `
      <span class="legend-item" style="background-color: ${item.color}">
        <span class="bar-legend-name">
          ${item.label}
          <span class="bar-legend-perc">${percent}%</span>
        </span>
        <span class="bar-legend-kg">
          ${item.value.toFixed(3)} kg
        </span>
      </span>`;
  }).join('');

const tsLegendWrapper = document.createElement('div');
tsLegendWrapper.appendChild(tsLegendDiv);
tsWrapper.appendChild(tsLegendWrapper);

/* --------- SECTOR PIE CHART --------- */

const sectorPieData = {{{sectorPieData}}}; // Already passed from server
const sectorContainer = document.getElementById('sector-pies-container');

for (const [sectorName, pieData] of Object.entries(sectorPieData)) {
  // Create the wrapper tabcontent div
  const tabContentDiv = document.createElement('div');
  tabContentDiv.id = sectorName.replace(/\s+/g, '');
  tabContentDiv.classList.add('sector-tabcontent');

  // Create canvas
  const pieCanvas = document.createElement('canvas');
  pieCanvas.id = `pieChart-${sectorName.replace(/\s+/g, '-')}`;
  pieCanvas.style.maxWidth = '600px';
  pieCanvas.style.maxHeight = '600px';
  pieCanvas.style.marginBottom = '20px';

  // Create chart wrapper
  const chartWrapper = document.createElement('div');
  chartWrapper.classList.add('chart-wrapper');
  chartWrapper.style.display = 'flex';
  chartWrapper.style.gap = '24px';
  chartWrapper.style.alignItems = 'flex-start';

  chartWrapper.appendChild(pieCanvas);

  // Create legend div
  const legendDiv = document.createElement('div');
  legendDiv.classList.add('bar-legend');

  // Create title <h2>
  const legendTitle = document.createElement('h2');
  legendTitle.classList.add('bar-legend-title');
  legendTitle.textContent = `${sectorName} Sector`;
  legendDiv.appendChild(legendTitle);

  // Compute total
  const total = pieData.data.reduce((sum, val) => sum + val, 0);

  // Generate legend HTML
  legendDiv.innerHTML += pieData.labels
    .map((label, i) => {
      const val = pieData.data[i];
      const percent = total ? ((val / total) * 100).toFixed(3).replace(/\.?0+$/, '') : '0';
      if (val === 0) return '';
      return `<span class="legend-item" style="background-color: ${pieData.backgroundColor[i]}">
          <span class="bar-legend-name">
              ${label}
              <span class="bar-legend-perc">${percent}%</span>
          </span>
          <span class="bar-legend-kg">
              ${val.toFixed(3)} kg
          </span>
      </span>`;
    }).join('');

  // Append title and legend to wrapper
  chartWrapper.appendChild(legendDiv);

  // Append wrapper to tab content
  tabContentDiv.appendChild(chartWrapper);

  // Append to main container
  sectorContainer.appendChild(tabContentDiv);

  // Chart.js setup
  new Chart(pieCanvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: pieData.labels,
      datasets: [{
        data: pieData.data,
        backgroundColor: pieData.backgroundColor,
        hoverOffset: 20
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const val = context.raw;
              const pct = total ? ((val / total) * 100).toFixed(3).replace(/\.?0+$/, '') : '0';
              return `${val.toFixed(3)} kg (${pct}%)`;
            }
          }
        },
        legend: {
            position: 'right'
        }
      }
    }
  });
}

</script>

<!-- File export script -->
<script>

const dataTitle = "{{wasteGen.title}}"
const table = document.getElementById("waste-comp-table");

function exportTableToCSV() {
    let csv = [];
    for (let row of table.rows) {
    let rowData = [];
    for (let cell of row.cells) {
        rowData.push(`"${cell.textContent.trim()}"`);
    }
    csv.push(rowData.join(","));
    }
    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${dataTitle}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportTableToExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "WasteData");
    XLSX.writeFile(wb, `${dataTitle}.xlsx`);
}

</script>

<!-- Access to chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetsJS (for Excel export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- JS behind the tabs -->
<script src="/js/tabs.js"></script>
<script src="/js/tabs-bar.js"></script>
<script src="/js/tabs-sector-pie.js"></script>

<style>

.info-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.info-grid .form-section {
  flex: 1 1 280px;
  min-width: 280px;
}

.user-profile {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
}

.user-profile td {
  padding: 0.5rem 0.75rem;
  border-bottom: 1px solid #eee;
}

.user-profile .label {
  font-weight: 600;
  color: #444;
  width: 50%;
}

.title-card h1 {
  font-size: 1.75rem;
}

.btn-submit {
  background-color: #28a745;
  border: none;
  padding: 0.6rem 1.2rem;
  color: white;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.2s ease;
}

.btn-submit:hover {
  background-color: #28a745;
}

.tab-new {
  text-align: center;
  margin-top: 2rem;
}

.tab-new button {
  background-color: #f1f1f1;
  border: none;
  padding: 0.75rem 1.5rem;
  margin: 0 5px;
  cursor: pointer;
  font-weight: 600;
  border-radius: 8px;
  transition: background-color 0.2s;
}

.tab-new button:hover,
.tab-new button.active {
  background-color: #d0e6ff;
}

.form-section {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin: 1.5rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.form-section h3 {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  color: #2c3e50;
  align-items: center;
}

.form-section h3 i {
  margin-right: 0.6rem;
  color: #127009;;
}

.form-section label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-section input[type="text"],
.form-section input[type="date"],
.form-section input[type="number"],
.form-section select {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.3rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.pie-legend {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 12px;
}

</style>
