<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/css/dashboard-style.css" />
    <link rel="stylesheet" type="text/css" href="/css/admin-style.css" />
    <link rel="stylesheet" type="text/css" href="/css/chart-style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars/dist/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/2fcb76e57d.js" crossorigin="anonymous"></script>
    
    <title>{{ title }}</title>
</head>
<body>
    <!-- Header: Contains user menu -->
    <header>
        <img src="/pictures/Greencycle-Logo.png" class="header-logo">
        <div class="header-logo-text">
            GreenCycle <text style="color:#d4ffd0; font-weight: bold;">DASHBOARD</text>
        </div>
        
        <!-- User Menu -->
        <div class="header-user">
            <!-- Display user menu (profile, settings, log out) -->           
            <div class="user-menu">
                <!-- User Menu Button -->
                <button class="user-menu-button">
                    <i class="fa-regular fa-circle-user header-user-icon"></i> {{uppercase user.lastname}}, {{user.firstname}}
                    <span class="user-menu-caret"><i class="fa-solid fa-caret-down"></i></span>
                </button>

                <div class="user-menu-content">
                    <a href="/dashboard/profile">
                        <i class="fa-solid fa-user"></i> Profile
                    </a>

                    {{#ifNotEquals user.supertype 2}}
                    <a href="/control-panel">
                        <i class="fa-solid fa-screwdriver-wrench"></i> Control Panel
                    </a>
                    {{/ifNotEquals}}
                    <a href="/">
                        <i class="fa-solid fa-house"></i> Return to Main Site
                    </a>
                    <a href="#" id="logout">
                        <i class="fa-solid fa-right-from-bracket"></i> Log Out
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation bar -->
    <div class="layout-wrapper">
        <nav id="sidebar" class="sidebar open">
            <div class="nav-btn-container">
                <button id="collapse-sidebar-btn" class="collapse-sidebar-btn">
                    <i class="fa-solid fa-angles-left"></i> Collapse Sidebar
                </button>

                <a href="/dashboard" class="{{#if current_home}}current{{/if}}">
                    <i class="fa-solid fa-house nav-icon"></i> Home
                </a>

                <a href="/dashboard/notifications" class="{{#if current_notifs}}current{{/if}}">
                    <i class="fa-solid fa-bell {{#ifNotEquals notifCount 0}}fa-shake{{/ifNotEquals}} nav-icon"></i> Notifications&nbsp;
                    <span class="notif-badge" id="notif-badge" style="{{#ifEquals notifCount 0}}display:none;{{/ifEquals}}">
                        {{notifCount}}
                    </span>
                </a>

                <a href="/dashboard/data/all" class="{{#if current_all}}current{{/if}}">
                    <i class="fa-solid fa-table nav-icon"></i> Data Entries
                </a>

                <a href="/dashboard/guide" class="{{#if current_guide}}current{{/if}}">
                    <i class="fa-solid fa-book-open nav-icon"></i></i> Waste Type Guide
                </a>

                <!-- Report Functions -->
                <div class="nav-divider">YOUR REPORTS</div>
                <a href="/dashboard/submit-report" class="{{#if current_report}}current{{/if}}">
                    <i class="fa-solid fa-file-upload nav-icon"></i>&nbsp; Submit Data Entry
                </a>

                <a href="/dashboard/data/user/revision" class="{{#if current_in_progress}}current{{/if}}">
                    <i class="fa-solid fa-file-pen nav-icon"></i> Submissions in Progress
                    <span class="notif-badge" id="notif-badge" style="{{#ifEquals revisionCount 0}}display:none;{{/ifEquals}}">
                        {{revisionCount}}
                    </span>
                </a>

                <a href="/dashboard/data/user/approved" class="{{#if current_user_report}}current{{/if}}">
                    <i class="fa-solid fa-clipboard-check nav-icon"></i> Approved Submissions
                </a>
                
                <a href="/dashboard/noncompliance" class="{{#if current_noncompliance}}current{{/if}}">
                    <i class="fa-solid fa-triangle-exclamation nav-icon"></i>&nbsp;Client Compliance Warning
                    {{#ifNotEquals cmpTotalCount 0}}
                        <span class="notif-badge"> {{cmpTotalCount}}</span>
                    {{/ifNotEquals}}
                </a>


                <!-- Only show functions if current user is NOT a client -->
                {{#ifNotEquals user.supertype 2}}
                    <div class="nav-divider">STAFF FUNCTIONS</div>

                    <a href="/dashboard/data/submissions/pending" class="{{#if current_datasubs}}current{{/if}}">
                        <i class="fa-solid fa-file-pen"></i>&nbsp; Review Data Submissions
                        {{#ifNotEquals pendingData 0}}
                            <span class="notif-badge">{{pendingData}}</span>
                        {{/ifNotEquals}}
                    </a>

                    <a href="/control-panel" style="background: none !important;">
                        <button id="collapse-sidebar-btn" class="collapse-sidebar-btn" style="margin-top: 5px !important;">
                            <i class="fa-solid fa-screwdriver-wrench"></i> CONTROL PANEL
                        </button>
                    </a>
                {{/ifNotEquals}}
            </div>
        </nav>
        
        <main id="main-content">
            <button id="open-sidebar-btn">
                <i class="fa-solid fa-bars"></i> Open Sidebar
            </button>

            {{#if show_generate_btn}}
            <button id="generate-btn">
                <i class="fa-solid fa-file-pdf"></i>&nbsp; Generate Report
            </button>
            {{/if}}

            {{{ body }}}
        </main>
    </div>

<!-- Modal (hidden by default) -->
<div id="pdfModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Generate Report</h2>
    <p>Are you sure you want to generate a PDF of this data entry?</p>
    <div class="modal-actions">
      <button id="confirm-generate" class="confirm-btn">Yes, Generate</button>
      <button id="cancel-generate" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<style>
/* Modal container */
.modal {
  display: none; /* hidden by default */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

/* Modal box */
.modal-content {
  background: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: 12px;
  width: 400px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Close button (X) */
.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}

/* Actions */
.modal-actions {
  margin-top: 20px;
  display: flex;
  justify-content: space-around;
}

.confirm-btn {
  background: #d32f2f;
  color: #fff;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.confirm-btn:hover {
  background: #b71c1c;
}

.cancel-btn {
  background: #ddd;
  color: #000;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.cancel-btn:hover {
  background: #bbb;
}
</style>

<script>

document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('open-sidebar-btn');
    const collapseBtn = document.getElementById('collapse-sidebar-btn');

    // --- Restore sidebar state from localStorage ---
    const savedState = localStorage.getItem('sidebarState');
    if (savedState === 'closed') {
        sidebar.classList.add('closed');
        sidebar.classList.remove('open');
        openBtn.style.display = 'flex';
        setTimeout(() => {
            openBtn.classList.add('visible');
        }, 10);
    } else {
        sidebar.classList.add('open');
    }

    // --- Collapse sidebar ---
    collapseBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
        sidebar.classList.add('closed');
        localStorage.setItem('sidebarState', 'closed');

        openBtn.style.display = 'flex';
        setTimeout(() => {
            openBtn.classList.remove('hidden');
            openBtn.classList.add('visible');
        }, 10);
    });

    // --- Open sidebar ---
    openBtn.addEventListener('click', () => {
        sidebar.classList.remove('closed');
        sidebar.classList.add('open');
        localStorage.setItem('sidebarState', 'open');

        openBtn.classList.add('hidden');
        openBtn.classList.remove('visible');
        setTimeout(() => {
            openBtn.style.display = 'none';
        }, 300);
    });

    // Logout code
    document.getElementById('logout').addEventListener('click', function (event) {
        event.preventDefault(); // Prevent default navigation

        fetch('/logout', { method: 'DELETE', credentials: 'include' })
        .then(response => {
            if (response.ok) {
            window.location.href = "/"; // Redirect to login after logout
            }
        })
        .catch(err => console.error("Logout failed", err));
    })
});

</script>

<!-- Modal script -->
<script>
// Modal elements
const modal = document.getElementById("pdfModal");
const generateBtn = document.getElementById("generate-btn");
const closeBtn = document.querySelector(".close");
const cancelBtn = document.getElementById("cancel-generate");
const confirmBtn = document.getElementById("confirm-generate");

// Show modal when clicking generate
generateBtn.addEventListener("click", () => {
  modal.style.display = "block";
});

// Close modal on X or cancel
closeBtn.addEventListener("click", () => modal.style.display = "none");
cancelBtn.addEventListener("click", () => modal.style.display = "none");

// Close modal if clicking outside the box
window.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
});

// Confirm generate
confirmBtn.addEventListener("click", () => {
  modal.style.display = "none";
  // TODO: Trigger your PDF generation logic here
  console.log("PDF generation triggered!");
  // Example: window.location.href = "/dashboard/entry/{{id}}/pdf";
});
</script>

</body>
</html>
